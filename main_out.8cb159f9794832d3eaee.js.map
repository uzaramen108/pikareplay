{"version":3,"file":"main_out.8cb159f9794832d3eaee.js","mappings":"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","sources":["webpack://pikachu-volleyball-p2p-online/./src/resources/js/replay/replay_saver_download.js","webpack://pikachu-volleyball-p2p-online/./src/resources/js/replay/main_out.js"],"sourcesContent":["'use strict';\r\nimport { settings } from '@pixi/settings';\r\nimport { SCALE_MODES } from '@pixi/constants';\r\nimport { Renderer, BatchRenderer, autoDetectRenderer } from '@pixi/core';\r\nimport { Prepare } from '@pixi/prepare';\r\nimport { Container } from '@pixi/display';\r\nimport { Loader } from '@pixi/loaders';\r\nimport { SpritesheetLoader } from '@pixi/spritesheet';\r\nimport { Ticker } from '@pixi/ticker';\r\nimport { CanvasRenderer } from '@pixi/canvas-renderer';\r\nimport { CanvasSpriteRenderer } from '@pixi/canvas-sprite';\r\nimport { CanvasPrepare } from '@pixi/canvas-prepare';\r\nimport '@pixi/canvas-display';\r\nimport { ASSETS_PATH } from '../offline_version_js/assets_path.js';\r\nimport { PikachuVolleyballReplay } from './pikavolley_replay.js';\r\nimport { serialize } from '../utils/serialize.js';\r\nimport { getHashCode } from '../utils/hash_code.js';\r\n\r\n// [핵심 수정] 주소창의 슬래시 유무에 따라 경로를 유동적으로 조정\r\nadjustAssetsPath();\r\n\r\nfunction adjustAssetsPath() {\r\n  // 현재 경로가 '/'로 끝나거나 'index.html'을 포함하면 \"깊은 경로\"로 인식\r\n  const path = window.location.pathname;\r\n  const isDeep = path.endsWith('/') || path.endsWith('index.html');\r\n  \r\n  // 깊은 경로면 2번(../../), 얕은 경로면 1번(../) 위로 올라감\r\n  const prefix = isDeep ? '../../' : '../';\r\n\r\n  // 경로가 아직 수정되지 않았다면 접두사 추가\r\n  if (!ASSETS_PATH.SPRITE_SHEET.startsWith('..')) {\r\n    ASSETS_PATH.SPRITE_SHEET = prefix + ASSETS_PATH.SPRITE_SHEET;\r\n    for (const prop in ASSETS_PATH.SOUNDS) {\r\n      ASSETS_PATH.SOUNDS[prop] = prefix + ASSETS_PATH.SOUNDS[prop];\r\n    }\r\n  }\r\n}\r\n\r\nsettings.RESOLUTION = 2;\r\nsettings.SCALE_MODE = SCALE_MODES.NEAREST;\r\nsettings.ROUND_PIXELS = true;\r\n\r\nRenderer.registerPlugin('prepare', Prepare);\r\nRenderer.registerPlugin('batch', BatchRenderer);\r\nCanvasRenderer.registerPlugin('prepare', CanvasPrepare);\r\nCanvasRenderer.registerPlugin('sprite', CanvasSpriteRenderer);\r\nLoader.registerPlugin(SpritesheetLoader);\r\n\r\nclass ReplaySaver {\r\n  constructor() {\r\n    this.renderer = autoDetectRenderer({\r\n      width: 432,\r\n      height: 304,\r\n      antialias: false,\r\n      backgroundColor: 0x000000,\r\n      backgroundAlpha: 1,\r\n      forceCanvas: true,\r\n      preserveDrawingBuffer: true,\r\n    });\r\n\r\n    this.stage = new Container();\r\n    this.loader = new Loader();\r\n    \r\n    this.pikaVolley = null;\r\n    this.ticker = new Ticker();\r\n    this.mediaRecorder = null;\r\n    this.recordedChunks = [];\r\n  }\r\n\r\n  initAndStart(file, onStatusChange, onFinish) {\r\n    this.onStatusChange = onStatusChange;\r\n    this.onFinish = onFinish;\r\n\r\n    const container = document.getElementById('game-canvas-container');\r\n    container.innerHTML = '';\r\n    container.appendChild(this.renderer.view);\r\n\r\n    this.loader.reset();\r\n\r\n    // adjustAssetsPath()가 적용된 경로 사용\r\n    this.loader.add(ASSETS_PATH.SPRITE_SHEET);\r\n    for (const prop in ASSETS_PATH.SOUNDS) {\r\n      this.loader.add(ASSETS_PATH.SOUNDS[prop]);\r\n    }\r\n\r\n    const reader = new FileReader();\r\n    reader.onload = (event) => {\r\n      this._parseAndLoadGame(event.target.result);\r\n    };\r\n    reader.readAsText(file);\r\n  }\r\n\r\n  _parseAndLoadGame(jsonString) {\r\n    let pack;\r\n    try {\r\n      const packWithComment = JSON.parse(jsonString);\r\n      pack = packWithComment.pack;\r\n      \r\n      const hash = pack.hash;\r\n      pack.hash = 0;\r\n      if (hash !== getHashCode(serialize(pack))) {\r\n        throw 'Error: File hash mismatch';\r\n      }\r\n    } catch (err) {\r\n      console.error(err);\r\n      if (this.onStatusChange) this.onStatusChange(\"오류: 손상된 리플레이 파일입니다.\");\r\n      return;\r\n    }\r\n\r\n    if (this.onStatusChange) this.onStatusChange(\"리소스 로딩 중...\");\r\n    \r\n    // 로딩 에러 상세 확인용 로그\r\n    this.loader.onError.add((err, loader, resource) => {\r\n        console.error(\"Resource Load Failed:\", resource.url, err);\r\n    });\r\n\r\n    this.loader.load(() => {\r\n      this._createGame(pack);\r\n    });\r\n  }\r\n\r\n  _createGame(pack) {\r\n    const TEXTURES = ASSETS_PATH.TEXTURES;\r\n    TEXTURES.WITH_COMPUTER = TEXTURES.WITH_FRIEND;\r\n\r\n    try {\r\n        this.pikaVolley = new PikachuVolleyballReplay(\r\n        this.stage,\r\n        this.loader.resources,\r\n        pack.roomID,\r\n        pack.nicknames,\r\n        pack.partialPublicIPs,\r\n        pack.inputs,\r\n        pack.options,\r\n        pack.chats\r\n        );\r\n    } catch (e) {\r\n        console.error(e);\r\n        // 리소스가 로드되지 않아서 발생하는 에러인지 확인\r\n        if (e.message && e.message.includes('undefined')) {\r\n            if (this.onStatusChange) this.onStatusChange(\"오류: 리소스 로딩 실패 (새로고침 후 다시 시도해보세요)\");\r\n        } else {\r\n            if (this.onStatusChange) this.onStatusChange(\"게임 생성 오류 (콘솔 확인)\");\r\n        }\r\n        return;\r\n    }\r\n\r\n    // 오디오 설정 (에러 방지용)\r\n    try {\r\n       // 필요한 경우 오디오 초기화\r\n    } catch(e) { console.log(\"Audio setup skipped\"); }\r\n\r\n    if (this.onStatusChange) this.onStatusChange(\"녹화 시작! 소리가 재생됩니다...\");\r\n    this._startRecordingLoop();\r\n  }\r\n\r\n  _startRecordingLoop() {\r\n    const canvas = this.renderer.view;\r\n    const stream = canvas.captureStream(60);\r\n\r\n    let mimeType = 'video/webm';\r\n    if (MediaRecorder.isTypeSupported('video/webm; codecs=vp9')) {\r\n      mimeType = 'video/webm; codecs=vp9';\r\n    } else if (MediaRecorder.isTypeSupported('video/webm; codecs=vp8')) {\r\n      mimeType = 'video/webm; codecs=vp8';\r\n    }\r\n\r\n    this.mediaRecorder = new MediaRecorder(stream, { \r\n        mimeType: mimeType,\r\n        videoBitsPerSecond: 5000000 \r\n    });\r\n    \r\n    this.recordedChunks = [];\r\n\r\n    this.mediaRecorder.ondataavailable = (e) => {\r\n      if (e.data.size > 0) this.recordedChunks.push(e.data);\r\n    };\r\n\r\n    this.mediaRecorder.onstop = () => {\r\n      this._finalizeDownload();\r\n    };\r\n\r\n    this.mediaRecorder.start();\r\n\r\n    this.ticker.stop();\r\n    this.ticker = new Ticker();\r\n    this.ticker.minFPS = 60;\r\n    this.ticker.maxFPS = 60; \r\n\r\n    this.ticker.add(() => {\r\n      this.renderer.render(this.stage);\r\n      if (this.pikaVolley) {\r\n        this.pikaVolley.gameLoop();\r\n\r\n        if (this.pikaVolley.replayFrameCounter >= this.pikaVolley.inputs.length) {\r\n            this.ticker.stop();\r\n            this.mediaRecorder.stop();\r\n            if (this.onStatusChange) this.onStatusChange(\"변환 완료! 파일 생성 중...\");\r\n        }\r\n      }\r\n    });\r\n\r\n    this.ticker.start();\r\n  }\r\n\r\n  _finalizeDownload() {\r\n    const blob = new Blob(this.recordedChunks, { type: 'video/webm' });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.style.display = 'none';\r\n    a.href = url;\r\n    a.download = `pikachu_replay_${Date.now()}.webm`;\r\n    document.body.appendChild(a);\r\n    a.click();\r\n    \r\n    setTimeout(() => {\r\n      document.body.removeChild(a);\r\n      window.URL.revokeObjectURL(url);\r\n      if (this.onFinish) this.onFinish();\r\n    }, 100);\r\n  }\r\n}\r\n\r\nexport const replaySaver = new ReplaySaver();","// [중요] 반드시 replay_saver_download.js를 import 해야 합니다.\r\nimport { replaySaver } from './replay_saver_download.js';\r\n\r\nconst uploadBtn = document.getElementById('record-btn');\r\nconst statusDiv = document.getElementById('status');\r\n\r\nif (uploadBtn) {\r\n  uploadBtn.addEventListener('click', () => {\r\n    // [소리 권한 확보 1] 버튼 클릭 시 AudioContext를 활성화해야 함\r\n    // (브라우저 정책상 사용자 제스처가 필수)\r\n    //@ts-ignore\r\n    const AudioContext = window.AudioContext || window.webkitAudioContext;\r\n    if (AudioContext) {\r\n        // 이미 생성된 컨텍스트가 있다면 resume()을 호출해 깨웁니다.\r\n        // (게임 엔진 내부에서 생성할 컨텍스트를 미리 깨우는 효과)\r\n        const dummyCtx = new AudioContext();\r\n        dummyCtx.resume().then(() => dummyCtx.close());\r\n    }\r\n\r\n    const input = document.createElement('input');\r\n    input.type = 'file';\r\n    input.accept = '.txt';\r\n\r\n    input.onchange = (event) => {\r\n      // @ts-ignore\r\n      const file = event.target.files[0];\r\n      if (!file) return;\r\n\r\n      statusDiv.innerText = \"리플레이 파일을 분석 중입니다...\";\r\n\r\n      replaySaver.initAndStart(\r\n        file,\r\n        (msg) => {\r\n          statusDiv.innerText = msg;\r\n        },\r\n        () => {\r\n          statusDiv.innerText = \"다운로드가 완료되었습니다!\";\r\n        }\r\n      );\r\n    };\r\n\r\n    input.click();\r\n  });\r\n} else {\r\n    console.error(\"버튼을 찾을 수 없습니다.\");\r\n}"],"names":["path","window","location","pathname","prefix","endsWith","SPRITE_SHEET","startsWith","prop","SOUNDS","adjustAssetsPath","settings","RESOLUTION","SCALE_MODE","NEAREST","ROUND_PIXELS","registerPlugin","replaySaver","constructor","this","renderer","width","height","antialias","backgroundColor","backgroundAlpha","forceCanvas","preserveDrawingBuffer","stage","loader","pikaVolley","ticker","mediaRecorder","recordedChunks","initAndStart","file","onStatusChange","onFinish","container","document","getElementById","innerHTML","appendChild","view","reset","add","reader","FileReader","onload","event","_parseAndLoadGame","target","result","readAsText","jsonString","pack","packWithComment","JSON","parse","hash","serialize","err","console","error","onError","resource","url","load","_createGame","TEXTURES","WITH_COMPUTER","WITH_FRIEND","resources","roomID","nicknames","partialPublicIPs","inputs","options","chats","e","message","includes","_startRecordingLoop","stream","captureStream","mimeType","MediaRecorder","isTypeSupported","videoBitsPerSecond","ondataavailable","data","size","push","onstop","_finalizeDownload","start","stop","minFPS","maxFPS","render","gameLoop","replayFrameCounter","length","blob","Blob","type","URL","createObjectURL","a","createElement","style","display","href","download","Date","now","body","click","setTimeout","removeChild","revokeObjectURL","uploadBtn","statusDiv","addEventListener","AudioContext","webkitAudioContext","dummyCtx","resume","then","close","input","accept","onchange","files","innerText","msg"],"sourceRoot":""}