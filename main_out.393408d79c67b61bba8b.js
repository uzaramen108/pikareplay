"use strict";(self.webpackChunkpikachu_volleyball_p2p_online=self.webpackChunkpikachu_volleyball_p2p_online||[]).push([[293],{4646:(e,t,s)=>{var i=s(4603),r=s(6787),o=s(592),a=s(3650),n=s(9449),d=s(7561),l=s(7049),c=s(3401),h=s(8077),u=s(4697),p=s(8505),g=(s(7229),s(6090)),m=s(3374),R=s(653),k=s(6212),S=s(6970);!function(){g.I.SPRITE_SHEET="../"+g.I.SPRITE_SHEET;for(const e in g.I.SOUNDS)g.I.SOUNDS[e]="../"+g.I.SOUNDS[e]}();const y=new class{constructor(){o.A4.registerPlugin("prepare",a.p8),o.A4.registerPlugin("batch",o.ch),h.KB.registerPlugin("prepare",p.S),h.KB.registerPlugin("sprite",u.$),d.aH.registerPlugin(l.A),i.W.RESOLUTION=2,i.W.SCALE_MODE=r.M6.NEAREST,i.W.ROUND_PIXELS=!0,this.ticker=null,this.renderer=null,this.stage=null,this.loader=null,this.pikaVolley=null,this.mediaRecorder=null,this.recordedChunks=[],this.isRecording=!1,this.currentPack=null}updateStatus(e){const t=document.getElementById("status");t&&(t.textContent=e),console.log(e)}handleRecordButtonClick(){if(this.isRecording)return void this.updateStatus("이미 녹화 중입니다...");const e=document.createElement("input");e.type="file",e.accept=".txt",e.onchange=e=>{const t=e.target.files[0];t&&this.loadReplayFile(t)},e.click()}loadReplayFile(e){this.updateStatus("리플레이 파일 로딩 중...");const t=document.getElementById("record-btn");t&&(t.disabled=!0);const s=new FileReader;s.onload=e=>{let s,i;try{s=JSON.parse(e.target.result),i=s.pack;const t=i.hash;if(i.hash=0,t!==(0,S.i)((0,k.l)(i)))throw new Error("파일 내용이 해시 코드와 일치하지 않습니다");this.initializeRenderer(i)}catch(e){console.error(e),this.updateStatus("파일 로딩 실패: "+e.message),t&&(t.disabled=!1)}},s.onerror=()=>{this.updateStatus("파일 읽기 실패"),t&&(t.disabled=!1)},s.readAsText(e)}initializeRenderer(e){this.updateStatus("게임 에셋 로딩 중..."),this.currentPack=e,this.renderer=(0,o.q5)({width:432,height:304,antialias:!1,backgroundColor:0,backgroundAlpha:1,forceCanvas:!0,preserveDrawingBuffer:!0}),this.stage=new n.mc,this.ticker=new c.Rv,this.ticker.minFPS=1,this.loader=new d.aH;const t=document.querySelector("#game-canvas-container");t.innerHTML="",t.appendChild(this.renderer.view);const s=g.I.TEXTURES;s.WITH_COMPUTER=s.WITH_FRIEND,this.loader.add(g.I.SPRITE_SHEET);for(const e in g.I.SOUNDS)this.loader.add(g.I.SOUNDS[e]);this.setupLoaderProgressBar(),this.loader.load((()=>{this.setupGame(e)}))}setupLoaderProgressBar(){const e=document.getElementById("loading-box"),t=document.getElementById("progress-bar");e&&t&&(e.classList.remove("hidden"),this.loader.onProgress.add((()=>{t.style.width=`${this.loader.progress}%`})),this.loader.onComplete.add((()=>{e.classList.add("hidden")})))}setupGame(e){this.updateStatus("게임 초기화 중..."),this.pikaVolley=new m.Z(this.stage,this.loader.resources,e.roomID,e.nicknames,e.partialPublicIPs,e.inputs,e.options,e.chats),(0,R.yg)(this.pikaVolley),this.pikaVolley.willDisplayChat=!1,this.ticker.add((()=>{this.renderer.render(this.stage),this.pikaVolley.gameLoop()})),setTimeout((()=>{this.startRecording(e)}),100)}startRecording(e){this.updateStatus("녹화 시작..."),this.recordedChunks=[],this.isRecording=!0;const t=this.renderer.view;try{const s=25,i=t.captureStream(s);let r="video/webm;codecs=vp9";MediaRecorder.isTypeSupported(r)||(r="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(r)||(r="video/webm")),this.mediaRecorder=new MediaRecorder(i,{mimeType:r,videoBitsPerSecond:25e5}),this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.recordedChunks.push(e.data)},this.mediaRecorder.onstop=()=>{this.saveVideoFile(e)},this.mediaRecorder.onerror=e=>{console.error("MediaRecorder 에러:",e),this.updateStatus("녹화 중 에러 발생"),this.isRecording=!1;const t=document.getElementById("record-btn");t&&(t.disabled=!1)},this.mediaRecorder.start(100),this.ticker.maxFPS=this.pikaVolley.normalFPS,this.ticker.start(),this.updateStatus(`녹화 중... (총 ${e.inputs.length} 프레임)`),this.monitorReplayProgress()}catch(e){console.error("녹화 시작 실패:",e),this.updateStatus("녹화 시작 실패: "+e.message),this.isRecording=!1;const t=document.getElementById("record-btn");t&&(t.disabled=!1)}}monitorReplayProgress(){const e=setInterval((()=>{if(!this.pikaVolley||!this.isRecording)return void clearInterval(e);const t=Math.floor(this.pikaVolley.replayFrameCounter/this.pikaVolley.inputs.length*100);this.updateStatus(`녹화 중... ${t}%`),this.pikaVolley.replayFrameCounter>=this.pikaVolley.inputs.length&&(clearInterval(e),this.stopRecording())}),500)}stopRecording(){this.isRecording&&(this.updateStatus("녹화 완료, 파일 저장 중..."),this.ticker.stop(),this.mediaRecorder&&"inactive"!==this.mediaRecorder.state?this.mediaRecorder.stop():this.saveVideoFile(this.currentPack||{}))}saveVideoFile(e){if(0===this.recordedChunks.length){this.updateStatus("녹화된 데이터가 없습니다"),this.isRecording=!1;const e=document.getElementById("record-btn");return void(e&&(e.disabled=!1))}const t=new Blob(this.recordedChunks,{type:"video/webm"}),s=URL.createObjectURL(t),i=new Date,r=`${i.getFullYear()}${("0"+(i.getMonth()+1)).slice(-2)}${("0"+i.getDate()).slice(-2)}`,o=`${("0"+i.getHours()).slice(-2)}${("0"+i.getMinutes()).slice(-2)}`;let a=`${r}_${o}_pikavolley_replay.webm`;e.nicknames&&2===e.nicknames.length&&(a=`${r}_${o}_${e.nicknames[0].replace(/[/\\?%*:|"<>]/g,"_")}_vs_${e.nicknames[1].replace(/[/\\?%*:|"<>]/g,"_")}.webm`);const n=document.createElement("a");n.href=s,n.download=a,n.style.display="none",document.body.appendChild(n),n.click(),setTimeout((()=>{document.body.removeChild(n),URL.revokeObjectURL(s)}),100),this.updateStatus("저장 완료! 다른 리플레이를 변환하려면 버튼을 다시 클릭하세요."),this.isRecording=!1;const d=document.getElementById("record-btn");d&&(d.disabled=!1),this.recordedChunks=[]}},b=document.getElementById("record-btn");b&&b.addEventListener("click",(()=>y.handleRecordButtonClick()))}},e=>{e.O(0,[244,415,476],(()=>e(e.s=4646))),e.O()}]);
//# sourceMappingURL=main_out.393408d79c67b61bba8b.js.map