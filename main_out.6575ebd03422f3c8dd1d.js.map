{"version":3,"file":"main_out.6575ebd03422f3c8dd1d.js","mappings":"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","sources":["webpack://pikachu-volleyball-p2p-online/./src/resources/js/replay/replay_saver_download.js","webpack://pikachu-volleyball-p2p-online/./src/resources/js/replay/main_out.js"],"sourcesContent":["'use strict';\r\nimport { settings } from '@pixi/settings';\r\nimport { SCALE_MODES } from '@pixi/constants';\r\nimport { Renderer, BatchRenderer, autoDetectRenderer } from '@pixi/core';\r\nimport { Prepare } from '@pixi/prepare';\r\nimport { Container } from '@pixi/display';\r\nimport { Loader } from '@pixi/loaders';\r\nimport { SpritesheetLoader } from '@pixi/spritesheet';\r\nimport { Ticker } from '@pixi/ticker';\r\nimport { CanvasRenderer } from '@pixi/canvas-renderer';\r\nimport { CanvasSpriteRenderer } from '@pixi/canvas-sprite';\r\nimport { CanvasPrepare } from '@pixi/canvas-prepare';\r\nimport '@pixi/canvas-display';\r\nimport { ASSETS_PATH } from '../offline_version_js/assets_path.js';\r\nimport { PikachuVolleyballReplay } from './pikavolley_replay.js';\r\nimport { serialize } from '../utils/serialize.js';\r\nimport { getHashCode } from '../utils/hash_code.js';\r\n\r\n// [핵심] Webpack 설정 변경 없이, 코드 레벨에서 경로 수정\r\n// ko/replay-download/index.html (2단계 깊이) -> ../../resources/assets/...\r\nadjustAssetsPath();\r\n\r\nfunction adjustAssetsPath() {\r\n  const prefix = '../../'; \r\n  // 만약 이미 수정된 상태라면 중복 적용 방지\r\n  if (!ASSETS_PATH.SPRITE_SHEET.startsWith(prefix)) {\r\n    ASSETS_PATH.SPRITE_SHEET = prefix + ASSETS_PATH.SPRITE_SHEET;\r\n    for (const prop in ASSETS_PATH.SOUNDS) {\r\n      ASSETS_PATH.SOUNDS[prop] = prefix + ASSETS_PATH.SOUNDS[prop];\r\n    }\r\n  }\r\n}\r\n\r\nsettings.RESOLUTION = 2;\r\nsettings.SCALE_MODE = SCALE_MODES.NEAREST;\r\nsettings.ROUND_PIXELS = true;\r\n\r\nRenderer.registerPlugin('prepare', Prepare);\r\nRenderer.registerPlugin('batch', BatchRenderer);\r\nCanvasRenderer.registerPlugin('prepare', CanvasPrepare);\r\nCanvasRenderer.registerPlugin('sprite', CanvasSpriteRenderer);\r\nLoader.registerPlugin(SpritesheetLoader);\r\n\r\nclass ReplaySaver {\r\n  constructor() {\r\n    this.renderer = autoDetectRenderer({\r\n      width: 432,\r\n      height: 304,\r\n      antialias: false,\r\n      backgroundColor: 0x000000,\r\n      backgroundAlpha: 1,\r\n      forceCanvas: true,\r\n      preserveDrawingBuffer: true,\r\n    });\r\n\r\n    this.stage = new Container();\r\n    this.loader = new Loader();\r\n    \r\n    this.pikaVolley = null;\r\n    this.ticker = new Ticker();\r\n    this.mediaRecorder = null;\r\n    this.recordedChunks = [];\r\n  }\r\n\r\n  initAndStart(file, onStatusChange, onFinish) {\r\n    this.onStatusChange = onStatusChange;\r\n    this.onFinish = onFinish;\r\n\r\n    const container = document.getElementById('game-canvas-container');\r\n    container.innerHTML = '';\r\n    container.appendChild(this.renderer.view);\r\n\r\n    this.loader.reset();\r\n\r\n    // adjustAssetsPath() 덕분에 여기서는 ASSETS_PATH를 그대로 쓰면 됩니다.\r\n    this.loader.add(ASSETS_PATH.SPRITE_SHEET);\r\n    for (const prop in ASSETS_PATH.SOUNDS) {\r\n      this.loader.add(ASSETS_PATH.SOUNDS[prop]);\r\n    }\r\n\r\n    const reader = new FileReader();\r\n    reader.onload = (event) => {\r\n      this._parseAndLoadGame(event.target.result);\r\n    };\r\n    reader.readAsText(file);\r\n  }\r\n\r\n  _parseAndLoadGame(jsonString) {\r\n    let pack;\r\n    try {\r\n      const packWithComment = JSON.parse(jsonString);\r\n      pack = packWithComment.pack;\r\n      \r\n      const hash = pack.hash;\r\n      pack.hash = 0;\r\n      if (hash !== getHashCode(serialize(pack))) {\r\n        throw 'Error: File hash mismatch';\r\n      }\r\n    } catch (err) {\r\n      console.error(err);\r\n      if (this.onStatusChange) this.onStatusChange(\"오류: 손상된 리플레이 파일입니다.\");\r\n      return;\r\n    }\r\n\r\n    if (this.onStatusChange) this.onStatusChange(\"리소스 로딩 중...\");\r\n    \r\n    // 로딩 에러 핸들링\r\n    this.loader.onError.add((err) => {\r\n        console.error(\"Resource Loading Error:\", err);\r\n        if (this.onStatusChange) this.onStatusChange(\"오류: 리소스 파일을 찾을 수 없습니다.\");\r\n    });\r\n\r\n    this.loader.load(() => {\r\n      this._createGame(pack);\r\n    });\r\n  }\r\n\r\n  _createGame(pack) {\r\n    const TEXTURES = ASSETS_PATH.TEXTURES;\r\n    TEXTURES.WITH_COMPUTER = TEXTURES.WITH_FRIEND;\r\n\r\n    try {\r\n        this.pikaVolley = new PikachuVolleyballReplay(\r\n        this.stage,\r\n        this.loader.resources,\r\n        pack.roomID,\r\n        pack.nicknames,\r\n        pack.partialPublicIPs,\r\n        pack.inputs,\r\n        pack.options,\r\n        pack.chats\r\n        );\r\n    } catch (e) {\r\n        console.error(e);\r\n        if (this.onStatusChange) this.onStatusChange(\"게임 생성 오류 (콘솔 확인)\");\r\n        return;\r\n    }\r\n\r\n    // [소리 설정]\r\n    // 1. fakeAudio(가짜 소리)를 덮어씌우는 코드를 제거하여 실제 오디오가 로드되게 함\r\n    // 2. 브라우저 정책상 사용자 인터랙션(버튼 클릭) 이후에만 오디오가 재생됨\r\n    // 3. 비디오 파일 내부에 소리를 넣는 것은 복잡하지만, 최소한 녹화 중 스피커로 소리는 들리게 설정됨\r\n    try {\r\n       // 필요한 경우 오디오 컨텍스트 resume (main_out.js에서 이미 처리함)\r\n    } catch(e) {\r\n        console.log(\"Audio warning:\", e);\r\n    }\r\n\r\n    if (this.onStatusChange) this.onStatusChange(\"녹화 시작! 소리가 재생됩니다...\");\r\n    this._startRecordingLoop();\r\n  }\r\n\r\n  _startRecordingLoop() {\r\n    const canvas = this.renderer.view;\r\n    const stream = canvas.captureStream(60);\r\n\r\n    let mimeType = 'video/webm';\r\n    if (MediaRecorder.isTypeSupported('video/webm; codecs=vp9')) {\r\n      mimeType = 'video/webm; codecs=vp9';\r\n    } else if (MediaRecorder.isTypeSupported('video/webm; codecs=vp8')) {\r\n      mimeType = 'video/webm; codecs=vp8';\r\n    }\r\n\r\n    this.mediaRecorder = new MediaRecorder(stream, { \r\n        mimeType: mimeType,\r\n        videoBitsPerSecond: 5000000 \r\n    });\r\n    \r\n    this.recordedChunks = [];\r\n\r\n    this.mediaRecorder.ondataavailable = (e) => {\r\n      if (e.data.size > 0) this.recordedChunks.push(e.data);\r\n    };\r\n\r\n    this.mediaRecorder.onstop = () => {\r\n      this._finalizeDownload();\r\n    };\r\n\r\n    this.mediaRecorder.start();\r\n\r\n    // Ticker 재설정 (60 FPS 정속)\r\n    this.ticker.stop();\r\n    this.ticker = new Ticker();\r\n    this.ticker.minFPS = 60;\r\n    this.ticker.maxFPS = 60; \r\n\r\n    this.ticker.add(() => {\r\n      this.renderer.render(this.stage);\r\n      if (this.pikaVolley) {\r\n        this.pikaVolley.gameLoop();\r\n\r\n        if (this.pikaVolley.replayFrameCounter >= this.pikaVolley.inputs.length) {\r\n            this.ticker.stop();\r\n            this.mediaRecorder.stop();\r\n            if (this.onStatusChange) this.onStatusChange(\"변환 완료! 파일 생성 중...\");\r\n        }\r\n      }\r\n    });\r\n\r\n    this.ticker.start();\r\n  }\r\n\r\n  _finalizeDownload() {\r\n    const blob = new Blob(this.recordedChunks, { type: 'video/webm' });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.style.display = 'none';\r\n    a.href = url;\r\n    a.download = `pikachu_replay_${Date.now()}.webm`;\r\n    document.body.appendChild(a);\r\n    a.click();\r\n    \r\n    setTimeout(() => {\r\n      document.body.removeChild(a);\r\n      window.URL.revokeObjectURL(url);\r\n      if (this.onFinish) this.onFinish();\r\n    }, 100);\r\n  }\r\n}\r\n\r\nexport const replaySaver = new ReplaySaver();","// [중요] 반드시 replay_saver_download.js를 import 해야 합니다.\r\nimport { replaySaver } from './replay_saver_download.js';\r\n\r\nconst uploadBtn = document.getElementById('record-btn');\r\nconst statusDiv = document.getElementById('status');\r\n\r\nif (uploadBtn) {\r\n  uploadBtn.addEventListener('click', () => {\r\n    // [소리 권한 확보 1] 버튼 클릭 시 AudioContext를 활성화해야 함\r\n    // (브라우저 정책상 사용자 제스처가 필수)\r\n    //@ts-ignore\r\n    const AudioContext = window.AudioContext || window.webkitAudioContext;\r\n    if (AudioContext) {\r\n        // 이미 생성된 컨텍스트가 있다면 resume()을 호출해 깨웁니다.\r\n        // (게임 엔진 내부에서 생성할 컨텍스트를 미리 깨우는 효과)\r\n        const dummyCtx = new AudioContext();\r\n        dummyCtx.resume().then(() => dummyCtx.close());\r\n    }\r\n\r\n    const input = document.createElement('input');\r\n    input.type = 'file';\r\n    input.accept = '.txt';\r\n\r\n    input.onchange = (event) => {\r\n      // @ts-ignore\r\n      const file = event.target.files[0];\r\n      if (!file) return;\r\n\r\n      statusDiv.innerText = \"리플레이 파일을 분석 중입니다...\";\r\n\r\n      replaySaver.initAndStart(\r\n        file,\r\n        (msg) => {\r\n          statusDiv.innerText = msg;\r\n        },\r\n        () => {\r\n          statusDiv.innerText = \"다운로드가 완료되었습니다!\";\r\n        }\r\n      );\r\n    };\r\n\r\n    input.click();\r\n  });\r\n} else {\r\n    console.error(\"버튼을 찾을 수 없습니다.\");\r\n}"],"names":["prefix","SPRITE_SHEET","startsWith","prop","SOUNDS","adjustAssetsPath","settings","RESOLUTION","SCALE_MODE","NEAREST","ROUND_PIXELS","registerPlugin","replaySaver","constructor","this","renderer","width","height","antialias","backgroundColor","backgroundAlpha","forceCanvas","preserveDrawingBuffer","stage","loader","pikaVolley","ticker","mediaRecorder","recordedChunks","initAndStart","file","onStatusChange","onFinish","container","document","getElementById","innerHTML","appendChild","view","reset","add","reader","FileReader","onload","event","_parseAndLoadGame","target","result","readAsText","jsonString","pack","packWithComment","JSON","parse","hash","serialize","err","console","error","onError","load","_createGame","TEXTURES","WITH_COMPUTER","WITH_FRIEND","resources","roomID","nicknames","partialPublicIPs","inputs","options","chats","e","_startRecordingLoop","stream","captureStream","mimeType","MediaRecorder","isTypeSupported","videoBitsPerSecond","ondataavailable","data","size","push","onstop","_finalizeDownload","start","stop","minFPS","maxFPS","render","gameLoop","replayFrameCounter","length","blob","Blob","type","url","URL","createObjectURL","a","createElement","style","display","href","download","Date","now","body","click","setTimeout","removeChild","window","revokeObjectURL","uploadBtn","statusDiv","addEventListener","AudioContext","webkitAudioContext","dummyCtx","resume","then","close","input","accept","onchange","files","innerText","msg"],"sourceRoot":""}