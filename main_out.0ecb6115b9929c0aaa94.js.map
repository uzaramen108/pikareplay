{"version":3,"file":"main_out.0ecb6115b9929c0aaa94.js","mappings":"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","sources":["webpack://pikachu-volleyball-p2p-online/./src/resources/js/replay/replay_saver_download.js","webpack://pikachu-volleyball-p2p-online/./src/resources/js/replay/main_out.js"],"sourcesContent":["'use strict';\r\nimport { settings } from '@pixi/settings';\r\nimport { SCALE_MODES } from '@pixi/constants';\r\nimport { Renderer, BatchRenderer, autoDetectRenderer } from '@pixi/core';\r\nimport { Prepare } from '@pixi/prepare';\r\nimport { Container } from '@pixi/display';\r\nimport { Loader } from '@pixi/loaders';\r\nimport { SpritesheetLoader } from '@pixi/spritesheet';\r\nimport { Ticker } from '@pixi/ticker';\r\nimport { CanvasRenderer } from '@pixi/canvas-renderer';\r\nimport { CanvasSpriteRenderer } from '@pixi/canvas-sprite';\r\nimport { CanvasPrepare } from '@pixi/canvas-prepare';\r\nimport '@pixi/canvas-display';\r\nimport { ASSETS_PATH } from '../offline_version_js/assets_path.js';\r\nimport { PikachuVolleyballReplay } from './pikavolley_replay.js';\r\nimport { serialize } from '../utils/serialize.js';\r\nimport { getHashCode } from '../utils/hash_code.js';\r\n\r\nsettings.RESOLUTION = 2;\r\nsettings.SCALE_MODE = SCALE_MODES.NEAREST;\r\nsettings.ROUND_PIXELS = true;\r\n\r\nRenderer.registerPlugin('prepare', Prepare);\r\nRenderer.registerPlugin('batch', BatchRenderer);\r\nCanvasRenderer.registerPlugin('prepare', CanvasPrepare);\r\nCanvasRenderer.registerPlugin('sprite', CanvasSpriteRenderer);\r\nLoader.registerPlugin(SpritesheetLoader);\r\n\r\nclass ReplaySaver {\r\n  constructor() {\r\n    this.renderer = autoDetectRenderer({\r\n      width: 432,\r\n      height: 304,\r\n      antialias: false,\r\n      backgroundColor: 0x000000,\r\n      backgroundAlpha: 1,\r\n      forceCanvas: true,\r\n      preserveDrawingBuffer: true,\r\n    });\r\n\r\n    this.stage = new Container();\r\n    this.loader = new Loader();\r\n    \r\n    // [해결 1] 404 에러 수정: 리소스 경로를 2단계 위로 설정\r\n    // 현재 위치: .../ko/replay-download/\r\n    // 리소스 위치: .../resources/assets/\r\n    this.loader.baseUrl = '../../'; \r\n\r\n    this.pikaVolley = null;\r\n    this.ticker = new Ticker();\r\n    this.mediaRecorder = null;\r\n    this.recordedChunks = [];\r\n    \r\n    // 오디오 캡처를 위한 변수\r\n    this.audioDest = null;\r\n    this.audioCtx = null;\r\n  }\r\n\r\n  initAndStart(file, onStatusChange, onFinish) {\r\n    this.onStatusChange = onStatusChange;\r\n    this.onFinish = onFinish;\r\n\r\n    const container = document.getElementById('game-canvas-container');\r\n    container.innerHTML = '';\r\n    container.appendChild(this.renderer.view);\r\n\r\n    this.loader.reset();\r\n    this.loader.add(ASSETS_PATH.SPRITE_SHEET);\r\n    \r\n    // 소리 파일 로드\r\n    for (const prop in ASSETS_PATH.SOUNDS) {\r\n      this.loader.add(ASSETS_PATH.SOUNDS[prop]);\r\n    }\r\n\r\n    const reader = new FileReader();\r\n    reader.onload = (event) => {\r\n      this._parseAndLoadGame(event.target.result);\r\n    };\r\n    reader.readAsText(file);\r\n  }\r\n\r\n  _parseAndLoadGame(jsonString) {\r\n    let pack;\r\n    try {\r\n      const packWithComment = JSON.parse(jsonString);\r\n      pack = packWithComment.pack;\r\n      \r\n      const hash = pack.hash;\r\n      pack.hash = 0;\r\n      if (hash !== getHashCode(serialize(pack))) {\r\n        throw 'Error: File hash mismatch';\r\n      }\r\n    } catch (err) {\r\n      console.error(err);\r\n      if (this.onStatusChange) this.onStatusChange(\"오류: 손상된 리플레이 파일입니다.\");\r\n      return;\r\n    }\r\n\r\n    if (this.onStatusChange) this.onStatusChange(\"리소스 로딩 중...\");\r\n    this.loader.load(() => {\r\n      this._createGame(pack);\r\n    });\r\n  }\r\n\r\n  _createGame(pack) {\r\n    const TEXTURES = ASSETS_PATH.TEXTURES;\r\n    TEXTURES.WITH_COMPUTER = TEXTURES.WITH_FRIEND;\r\n\r\n    this.pikaVolley = new PikachuVolleyballReplay(\r\n      this.stage,\r\n      this.loader.resources,\r\n      pack.roomID,\r\n      pack.nicknames,\r\n      pack.partialPublicIPs,\r\n      pack.inputs,\r\n      pack.options,\r\n      pack.chats\r\n    );\r\n\r\n    // [해결 2] 소리 활성화 (fakeAudio 제거)\r\n    // 기존에 있던 this.pikaVolley.audio = ... 코드를 삭제하여 실제 오디오를 사용하게 함\r\n\r\n    // [소리 녹음 준비] 게임의 AudioContext 낚아채기\r\n    // PikachuVolleyball 내부는 보통 전역 AudioContext나 내부 컨텍스트를 사용함.\r\n    // 여기서는 안전하게 브라우저의 전역 오디오 그래프를 통해 캡처를 시도합니다.\r\n    this._setupAudioCapture();\r\n\r\n    if (this.onStatusChange) this.onStatusChange(\"녹화 시작! 소리가 재생됩니다...\");\r\n    this._startRecordingLoop();\r\n  }\r\n\r\n  _setupAudioCapture() {\r\n    // 1. PIXI Sound 또는 Web Audio API 컨텍스트 찾기\r\n    // 보통 window.AudioContext가 사용됨.\r\n    // 기존 게임 코드를 건드리지 않고 출력을 가로채기 위해 약간의 트릭 사용\r\n    \r\n    // 만약 pikaVolley 객체 내부에 audioContext 접근자가 있다면 가져옴\r\n    // (여기서는 일반적인 Web Audio API 동작을 가정)\r\n    \r\n    // 참고: 이미 생성된 AudioContext에 접근하기 어렵다면 \r\n    // 녹화되는 파일에 소리를 넣는 건 구조상 매우 어렵습니다.\r\n    // 하지만, 일단 재생은 되도록(스피커로 들리도록) fakeAudio를 제거했으므로\r\n    // 사용자가 시스템 소리를 들을 수는 있습니다.\r\n    \r\n    // 여기서는 '재생'이라도 되게 하는 것이 1차 목표입니다.\r\n    // 비디오 파일 내부로 소리를 넣으려면 게임 엔진의 'Master Gain Node'를 찾아야 합니다.\r\n    // 구조상 접근이 어렵다면 비디오는 무음으로 녹화되지만, 녹화 중 소리는 들리게 됩니다.\r\n  }\r\n\r\n  _startRecordingLoop() {\r\n    const canvas = this.renderer.view;\r\n    \r\n    // 1. 비디오 스트림 (60FPS)\r\n    const stream = canvas.captureStream(60);\r\n\r\n    // [오디오 녹음 시도]\r\n    // 만약 게임이 Web Audio API를 쓰고 있다면, 그 소리를 스트림에 섞어야 함.\r\n    // 하지만 외부에서 내부 오디오 노드를 찾기 어려우므로, \r\n    // 일단은 '비디오만 녹화'되더라도 에러 없이 진행되도록 함.\r\n    // (소리를 파일에 넣으려면 pikaVolley 내부의 audio context destination을 streamDestination으로 연결해야 함)\r\n\r\n    let mimeType = 'video/webm';\r\n    if (MediaRecorder.isTypeSupported('video/webm; codecs=vp9')) {\r\n      mimeType = 'video/webm; codecs=vp9';\r\n    } else if (MediaRecorder.isTypeSupported('video/webm; codecs=vp8')) {\r\n      mimeType = 'video/webm; codecs=vp8';\r\n    }\r\n\r\n    // 소리 녹음을 위한 옵션 (bitsPerSecond 등) 추가 가능\r\n    this.mediaRecorder = new MediaRecorder(stream, { \r\n        mimeType: mimeType,\r\n        videoBitsPerSecond: 5000000 // 화질 개선 (5Mbps)\r\n    });\r\n    \r\n    this.recordedChunks = [];\r\n\r\n    this.mediaRecorder.ondataavailable = (e) => {\r\n      if (e.data.size > 0) this.recordedChunks.push(e.data);\r\n    };\r\n\r\n    this.mediaRecorder.onstop = () => {\r\n      this._finalizeDownload();\r\n    };\r\n\r\n    this.mediaRecorder.start();\r\n\r\n    // Ticker 재설정\r\n    this.ticker.stop();\r\n    this.ticker = new Ticker();\r\n    this.ticker.minFPS = 60;\r\n    this.ticker.maxFPS = 60; \r\n\r\n    this.ticker.add(() => {\r\n      this.renderer.render(this.stage);\r\n      if (this.pikaVolley) {\r\n        this.pikaVolley.gameLoop();\r\n\r\n        if (this.pikaVolley.replayFrameCounter >= this.pikaVolley.inputs.length) {\r\n            this.ticker.stop();\r\n            this.mediaRecorder.stop();\r\n            if (this.onStatusChange) this.onStatusChange(\"변환 완료! 파일 생성 중...\");\r\n        }\r\n      }\r\n    });\r\n\r\n    this.ticker.start();\r\n  }\r\n\r\n  _finalizeDownload() {\r\n    const blob = new Blob(this.recordedChunks, { type: 'video/webm' });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.style.display = 'none';\r\n    a.href = url;\r\n    a.download = `pikachu_replay_${Date.now()}.webm`;\r\n    document.body.appendChild(a);\r\n    a.click();\r\n    \r\n    setTimeout(() => {\r\n      document.body.removeChild(a);\r\n      window.URL.revokeObjectURL(url);\r\n      if (this.onFinish) this.onFinish();\r\n    }, 100);\r\n  }\r\n}\r\n\r\nexport const replaySaver = new ReplaySaver();","// [중요] 반드시 replay_saver_download.js를 import 해야 합니다.\r\nimport { replaySaver } from './replay_saver_download.js';\r\n\r\nconst uploadBtn = document.getElementById('record-btn');\r\nconst statusDiv = document.getElementById('status');\r\n\r\nif (uploadBtn) {\r\n  uploadBtn.addEventListener('click', () => {\r\n    // [소리 권한 확보 1] 버튼 클릭 시 AudioContext를 활성화해야 함\r\n    // (브라우저 정책상 사용자 제스처가 필수)\r\n    //@ts-ignore\r\n    const AudioContext = window.AudioContext || window.webkitAudioContext;\r\n    if (AudioContext) {\r\n        // 이미 생성된 컨텍스트가 있다면 resume()을 호출해 깨웁니다.\r\n        // (게임 엔진 내부에서 생성할 컨텍스트를 미리 깨우는 효과)\r\n        const dummyCtx = new AudioContext();\r\n        dummyCtx.resume().then(() => dummyCtx.close());\r\n    }\r\n\r\n    const input = document.createElement('input');\r\n    input.type = 'file';\r\n    input.accept = '.txt';\r\n\r\n    input.onchange = (event) => {\r\n      // @ts-ignore\r\n      const file = event.target.files[0];\r\n      if (!file) return;\r\n\r\n      statusDiv.innerText = \"리플레이 파일을 분석 중입니다...\";\r\n\r\n      replaySaver.initAndStart(\r\n        file,\r\n        (msg) => {\r\n          statusDiv.innerText = msg;\r\n        },\r\n        () => {\r\n          statusDiv.innerText = \"다운로드가 완료되었습니다!\";\r\n        }\r\n      );\r\n    };\r\n\r\n    input.click();\r\n  });\r\n} else {\r\n    console.error(\"버튼을 찾을 수 없습니다.\");\r\n}"],"names":["settings","RESOLUTION","SCALE_MODE","NEAREST","ROUND_PIXELS","registerPlugin","replaySaver","constructor","this","renderer","width","height","antialias","backgroundColor","backgroundAlpha","forceCanvas","preserveDrawingBuffer","stage","loader","baseUrl","pikaVolley","ticker","mediaRecorder","recordedChunks","audioDest","audioCtx","initAndStart","file","onStatusChange","onFinish","container","document","getElementById","innerHTML","appendChild","view","reset","add","SPRITE_SHEET","prop","SOUNDS","reader","FileReader","onload","event","_parseAndLoadGame","target","result","readAsText","jsonString","pack","packWithComment","JSON","parse","hash","serialize","err","console","error","load","_createGame","TEXTURES","WITH_COMPUTER","WITH_FRIEND","resources","roomID","nicknames","partialPublicIPs","inputs","options","chats","_setupAudioCapture","_startRecordingLoop","stream","captureStream","mimeType","MediaRecorder","isTypeSupported","videoBitsPerSecond","ondataavailable","e","data","size","push","onstop","_finalizeDownload","start","stop","minFPS","maxFPS","render","gameLoop","replayFrameCounter","length","blob","Blob","type","url","URL","createObjectURL","a","createElement","style","display","href","download","Date","now","body","click","setTimeout","removeChild","window","revokeObjectURL","uploadBtn","statusDiv","addEventListener","AudioContext","webkitAudioContext","dummyCtx","resume","then","close","input","accept","onchange","files","innerText","msg"],"sourceRoot":""}