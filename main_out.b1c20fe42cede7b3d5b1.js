"use strict";(self.webpackChunkpikachu_volleyball_p2p_online=self.webpackChunkpikachu_volleyball_p2p_online||[]).push([[293],{4646:(e,t,s)=>{var i=s(4603),d=s(6787),n=s(592),a=s(3650),o=s(9449),r=s(7561),c=s(7049),l=s(3401),h=s(8077),u=s(4697),p=s(8505),m=(s(7229),s(6090)),g=s(3374),k=s(653),y=s(6212),E=s(6970);!function(){m.I.SPRITE_SHEET="../"+m.I.SPRITE_SHEET;for(const e in m.I.SOUNDS)m.I.SOUNDS[e]="../"+m.I.SOUNDS[e]}();const v=new class{constructor(){n.A4.registerPlugin("prepare",a.p8),n.A4.registerPlugin("batch",n.ch),h.KB.registerPlugin("prepare",p.S),h.KB.registerPlugin("sprite",u.$),r.aH.registerPlugin(c.A),i.W.RESOLUTION=2,i.W.SCALE_MODE=d.M6.NEAREST,i.W.ROUND_PIXELS=!0,this.renderer=null,this.stage=null,this.loader=null,this.ticker=null,this.pikaVolley=null,this.currentPack=null,this.mediaRecorder=null,this.recordedChunks=[],this.isRecording=!1}updateStatus(e){const t=document.getElementById("status");t&&(t.textContent=e),console.log(e)}handleRecordButtonClick(){if(this.isRecording)return void this.updateStatus("이미 처리 중입니다...");const e=document.createElement("input");e.type="file",e.accept=".txt",e.onchange=e=>{const t=e.target.files[0];t&&this.loadReplayFile(t)},e.click()}loadReplayFile(e){this.updateStatus("리플레이 파일 로딩 중...");const t=document.getElementById("record-btn");t&&(t.disabled=!0);const s=document.getElementById("loading-overlay");s&&s.classList.remove("hidden");const i=new FileReader;i.onload=e=>{try{const t=JSON.parse(e.target.result).pack,s=t.hash;if(t.hash=0,s!==(0,E.i)((0,y.l)(t)))throw new Error("파일 내용이 해시 코드와 일치하지 않습니다");this.initializeRenderer(t)}catch(e){console.error(e),this.updateStatus("파일 로딩 실패: "+e.message),t&&(t.disabled=!1),s&&s.classList.add("hidden")}},i.onerror=()=>{this.updateStatus("파일 읽기 실패"),t&&(t.disabled=!1),s&&s.classList.add("hidden")},i.readAsText(e)}initializeRenderer(e){this.updateStatus("게임 에셋 로딩 중..."),this.currentPack=e,this.renderer=(0,n.q5)({width:432,height:304,antialias:!1,backgroundColor:0,backgroundAlpha:1,forceCanvas:!0,preserveDrawingBuffer:!0}),this.stage=new o.mc,this.ticker=new l.Rv,this.ticker.minFPS=1,this.loader=new r.aH;const t=document.querySelector("#game-canvas-container");t.innerHTML="",t.appendChild(this.renderer.view);const s=m.I.TEXTURES;s.WITH_COMPUTER=s.WITH_FRIEND,this.loader.add(m.I.SPRITE_SHEET);for(const e in m.I.SOUNDS)this.loader.add(m.I.SOUNDS[e]);this.setupLoaderProgressBar(),this.loader.load((()=>this.setupGame(e)))}setupLoaderProgressBar(){const e=document.getElementById("progress-bar");e&&this.loader.onProgress.add((()=>{e.style.width=`${this.loader.progress}%`}))}setupGame(e){this.updateStatus("게임 초기화 중..."),this.pikaVolley=new g.Z(this.stage,this.loader.resources,e.roomID,e.nicknames,e.partialPublicIPs,e.inputs,e.options,e.chats),(0,k.yg)(this.pikaVolley),this.pikaVolley.willDisplayChat=!0,(0,k.Az)(!0);const t=document.getElementById("show-nicknames-checkbox"),s=document.getElementById("show-ip-addresses-checkbox"),i=document.getElementById("show-chat-checkbox");t&&(t.checked=!0,t.dispatchEvent(new Event("change"))),s&&(s.checked=!0,s.dispatchEvent(new Event("change"))),i&&(i.checked=!0,i.dispatchEvent(new Event("change"))),this.pikaVolley.audio.turnBGMVolume(!1),this.pikaVolley.audio.sounds.bgm&&this.pikaVolley.audio.sounds.bgm.center&&(this.pikaVolley.audio.sounds.bgm.center.stop(),this.pikaVolley.audio.sounds.bgm.center.play=function(){},this.pikaVolley.audio.sounds.bgm.center.isPlaying=!1),this.pikaVolley.audio.turnSFXVolume(!0),this.ticker.add((()=>{this.renderer.render(this.stage),this.pikaVolley.gameLoop()})),setTimeout((()=>this.startRecording()),100)}startRecording(){this.updateStatus("녹화 준비 중..."),this.recordedChunks=[],this.isRecording=!0;const e=this.renderer.view;try{const t=30,s=e.captureStream(t);let i="video/webm;codecs=vp9";MediaRecorder.isTypeSupported(i)||(i="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(i)||(i="video/webm")),this.mediaRecorder=new MediaRecorder(s,{mimeType:i,videoBitsPerSecond:25e5}),this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.recordedChunks.push(e.data)},this.mediaRecorder.onstop=()=>{this.saveVideoFile()},this.mediaRecorder.onerror=e=>{console.error("MediaRecorder 에러:",e),this.updateStatus("녹화 중 에러 발생"),this.isRecording=!1;const t=document.getElementById("record-btn");t&&(t.disabled=!1)},this.mediaRecorder.start(100),this.ticker.maxFPS=30,this.ticker.start(),this.updateStatus("녹화 중... 0%"),this.monitorProgress()}catch(e){console.error("녹화 시작 실패:",e),this.updateStatus("녹화 시작 실패: "+e.message),this.isRecording=!1;const t=document.getElementById("record-btn");t&&(t.disabled=!1)}}monitorProgress(){const e=this.pikaVolley.inputs.length,t=document.getElementById("progress-bar"),s=setInterval((()=>{if(!this.pikaVolley||!this.isRecording)return void clearInterval(s);const i=this.pikaVolley.replayFrameCounter,d=Math.floor(i/e*100);this.updateStatus(`녹화 중... ${d}%`),t&&(t.style.width=`${d}%`),i>=e&&(clearInterval(s),this.stopRecording())}),500)}stopRecording(){this.isRecording&&(this.updateStatus("녹화 완료, 파일 저장 중..."),this.ticker.stop(),this.mediaRecorder&&"inactive"!==this.mediaRecorder.state?this.mediaRecorder.stop():this.saveVideoFile())}saveVideoFile(){if(0===this.recordedChunks.length){this.updateStatus("녹화된 데이터가 없습니다"),this.isRecording=!1;const e=document.getElementById("record-btn");return void(e&&(e.disabled=!1))}const e=new Blob(this.recordedChunks,{type:"video/webm"}),t=URL.createObjectURL(e),s=new Date,i=`${s.getFullYear()}${("0"+(s.getMonth()+1)).slice(-2)}${("0"+s.getDate()).slice(-2)}`,d=`${("0"+s.getHours()).slice(-2)}${("0"+s.getMinutes()).slice(-2)}`;let n=`${i}_${d}_pikavolley_replay.webm`;const a=this.currentPack;a&&a.nicknames&&2===a.nicknames.length&&(n=`${i}_${d}_${a.nicknames[0].replace(/[/\\?%*:|"<>]/g,"_")}_vs_${a.nicknames[1].replace(/[/\\?%*:|"<>]/g,"_")}.webm`);const o=document.createElement("a");o.href=t,o.download=n,o.style.display="none",document.body.appendChild(o),o.click(),setTimeout((()=>{document.body.removeChild(o),URL.revokeObjectURL(t)}),100),this.updateStatus("완료! 다른 리플레이를 변환하려면 버튼을 다시 클릭하세요."),this.isRecording=!1;const r=document.getElementById("record-btn");r&&(r.disabled=!1),this.recordedChunks=[];const c=document.getElementById("loading-overlay");c&&c.classList.add("hidden")}},R=document.getElementById("record-btn");R&&R.addEventListener("click",(()=>v.handleRecordButtonClick())),document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("show-nicknames-checkbox"),t=document.getElementById("show-ip-addresses-checkbox"),s=document.getElementById("show-chat-checkbox"),i=document.getElementById("player1-nickname"),d=document.getElementById("player2-nickname"),n=document.getElementById("player1-partial-ip"),a=document.getElementById("player2-partial-ip");e&&e.addEventListener("change",(()=>{e.checked?(i&&i.classList.remove("hidden"),d&&d.classList.remove("hidden")):(i&&i.classList.add("hidden"),d&&d.classList.add("hidden"))})),t&&t.addEventListener("change",(()=>{t.checked?(n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden")):(n&&n.classList.add("hidden"),a&&a.classList.add("hidden"))})),s&&s.addEventListener("change",(()=>{s.checked?(0,k.Az)(!0):(0,k.Az)(!1)}))}))}},e=>{e.O(0,[244,415,476],(()=>e(e.s=4646))),e.O()}]);
//# sourceMappingURL=main_out.b1c20fe42cede7b3d5b1.js.map