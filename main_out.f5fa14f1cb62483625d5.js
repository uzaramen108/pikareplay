"use strict";(self.webpackChunkpikachu_volleyball_p2p_online=self.webpackChunkpikachu_volleyball_p2p_online||[]).push([[293],{5128:(e,t,i)=>{var s=i(4603),o=i(6787),a=i(592),r=i(3650),n=i(9449),l=i(7561),c=i(7049),d=i(3401),h=i(8077),p=i(4697),u=i(8505),m=(i(7229),i(6090)),y=i(7391),g=i.n(y),k=i(94),b=i(5716),S=i(653),E=i(7147),w=i(6806),I=i(1674),P=i(4805),C=i(6212),R=i(6970);const v=new class{constructor(){a.A4.registerPlugin("prepare",r.p8),a.A4.registerPlugin("batch",a.ch),h.KB.registerPlugin("prepare",u.S),h.KB.registerPlugin("sprite",p.$),l.aH.registerPlugin(c.A),s.W.RESOLUTION=2,s.W.SCALE_MODE=o.M6.NEAREST,s.W.ROUND_PIXELS=!0,this.ticker=new d.Rv,this.ticker.minFPS=1,this.renderer=(0,a.q5)({width:432,height:304,antialias:!1,backgroundColor:0,backgroundAlpha:1,forceCanvas:!0,preserveDrawingBuffer:!0}),this.stage=new n.mc,this.loader=new l.aH,this.pikaVolley=null,this.playBackSpeedTimes=1,this.playBackSpeedFPS=null}readFile(e){const t=m.I.TEXTURES;t.WITH_COMPUTER=t.WITH_FRIEND,document.querySelector("#game-canvas-container").appendChild(this.renderer.view),this.renderer.render(this.stage),this.ticker.add((()=>{this.renderer.render(this.stage),A(this.pikaVolley.timeCurrent),this.pikaVolley.gameLoop()})),this.pikaVolley.replayFrameCounter>=this.pikaVolley.inputs.length&&(this.ticker.stop(),window.dispatchEvent(new Event("pikaReplayFinished"))),this.loader.add(m.I.SPRITE_SHEET);for(const e in m.I.SOUNDS)this.loader.add(m.I.SOUNDS[e]);!function(e){const t=document.getElementById("loading-box"),i=document.getElementById("progress-bar");e.onProgress.add((()=>{i.style.width=`${e.progress}%`})),e.onComplete.add((()=>{t.classList.add("hidden")}))}(this.loader);const i=new FileReader;i.onload=e=>{let t,i;try{t=JSON.parse(e.target.result),i=t.pack;const s=i.hash;if(i.hash=0,s!==(0,R.i)((0,C.l)(i)))throw"Error: The file content is not matching the hash code"}catch(e){return console.log(e),void N()}var s;s=function(e){const t=[];let i=0,s=e.options[i];for(;s;){if(s[1].speed){let e=null;switch(s[1].speed){case"slow":e=20;break;case"medium":e=25;break;case"fast":e=30}const i=s[0];t.push([i,e])}i++,s=e.options[i]}let o=0,a=0,r=25;for(let e=0;e<t.length;e++){const i=t[e][0];o+=(i-a)/r,a=i,r=t[e][1]}return o+=(e.inputs.length-a)/r,o}(i),document.getElementById("time-duration").textContent=H(s),this.loader.load((()=>{var e;this.pikaVolley=new U(this.stage,this.loader.resources,i.roomID,i.nicknames,i.partialPublicIPs,i.inputs,i.options,i.chats),(0,S.yg)(this.pikaVolley),e=i.inputs.length,B.max=e,this.seekFrame(0),this.ticker.start(),function(){const e=document.getElementById("play-pause-btn");v.ticker.started?e.textContent=document.getElementById("pause-mark").textContent:e.textContent=document.getElementById("play-mark").textContent}(),B.disabled=!1,f.disabled=!1,F.disabled=!1,T.disabled=!1,D.disabled=!1,L.disabled=!1,M.disabled=!1,V.disabled=!1,x.disabled=!1,O.disabled=!1,window.dispatchEvent(new Event("pikaReplayLoaded"))}))};try{i.readAsText(e)}catch(e){return console.log(e),void N()}}seekFrame(e){if((0,S.lD)(),document.getElementById("notice-end-of-replay").classList.add("hidden"),this.ticker.stop(),this.pikaVolley.initializeForReplay(),e>0){for(let t=0;t<e;t++)this.pikaVolley.gameLoopSilent();this.renderer.render(this.stage)}A(this.pikaVolley.timeCurrent)}seekRelativeTime(e){const t=Math.max(0,this.pikaVolley.replayFrameCounter+e*this.pikaVolley.normalFPS);this.seekFrame(t)}adjustPlaybackSpeedTimes(e){this.playBackSpeedFPS=null,this.playBackSpeedTimes=e,this.ticker.maxFPS=this.pikaVolley.normalFPS*this.playBackSpeedTimes,_()}adjustPlaybackSpeedFPS(e){this.playBackSpeedTimes=null,this.playBackSpeedFPS=e,this.ticker.maxFPS=this.playBackSpeedFPS,_()}stopBGM(){this.pikaVolley.audio.sounds.bgm.center.stop()}playBGMProperly(){this.pikaVolley.isBGMPlaying&&this.pikaVolley.audio.sounds.bgm.center.play({start:this.pikaVolley.timeBGM})}},B=document.getElementById("scrubber-range-input"),f=document.getElementById("play-pause-btn"),F=document.getElementById("seek-backward-1"),T=document.getElementById("seek-forward-1"),D=document.getElementById("seek-backward-3"),L=document.getElementById("seek-forward-3"),M=document.getElementById("speed-btn-5-fps"),V=document.getElementById("speed-btn-half-times"),x=document.getElementById("speed-btn-1-times"),O=document.getElementById("speed-btn-2-times");function _(){document.getElementById("fps-input").value=v.ticker.maxFPS}function N(){document.getElementById("notice-file-open-error").classList.remove("hidden")}function A(e){document.getElementById("time-current").textContent=H(e)}function H(e){const t=Math.floor(e%60),i=Math.floor(e/60)%60,s=Math.floor(Math.floor(e/60)/60);return s>0?`${String(s)}:${("0"+i).slice(-2)}:${("0"+t).slice(-2)}`:`${String(i)}:${("0"+t).slice(-2)}`}class U extends k.q{constructor(e,t,i,s,o,a,r,n){super(e,t),this.noInputFrameTotal.menu=1/0,this.roomId=i,this.nicknames=s,this.partialPublicIPs=o,this.inputs=a,this.options=r,this.chats=n,this.player1Keyboard={xDirection:0,yDirection:0,powerHit:0,getInput:()=>{}},this.player2Keyboard={xDirection:0,yDirection:0,powerHit:0,getInput:()=>{}},this.keyboardArray=[this.player1Keyboard,this.player2Keyboard],this.willDisplayChat=!0;const l={play:()=>{},stop:()=>{}};this.fakeAudio={sounds:{bgm:{fake:!0,center:{isPlaying:!1},play:function(){this.center.isPlaying=!0},stop:function(){this.center.isPlaying=!1}},pipikachu:l,pika:l,chu:l,pi:l,pikachu:l,powerHit:l,ballTouchesGround:l}},this.initializeForReplay()}initializeForReplay(){for(const e in this.audio.sounds)this.audio.sounds[e].stop();this.timeCurrent=0,this.timeBGM=0,this.isBGMPlaying=!1,this.replayFrameCounter=0,this.chatCounter=0,this.optionsCounter=0;const e=g().alea(this.roomId.slice(10));(0,b.p)(e);const t=g().alea(this.roomId.slice(10,15)),i=g().alea(this.roomId.slice(15));(0,S.pt)(t,i),this.view.game.cloudArray=[];for(let e=0;e<10;e++)this.view.game.cloudArray.push(new w.Es);this.view.game.wave=new w.wH,this.view.intro.visible=!1,this.view.menu.visible=!1,this.view.game.visible=!1,this.view.fadeInOut.visible=!1,this.physics=new I.vW(!0,!0),this.normalFPS=25,this.slowMotionFPS=5,this.SLOW_MOTION_FRAMES_NUM=6,this.slowMotionFramesLeft=0,this.slowMotionNumOfSkippedFrames=0,this.selectedWithWho=0,this.scores=[0,0],this.winningScore=15,this.gameEnded=!1,this.roundEnded=!1,this.isPlayer2Serve=!1,this.frameCounter=0,this.noInputFrameCounter=0,this.paused=!1,this.isStereoSound=!0,this._isPracticeMode=!1,this.isRoomCreatorPlayer2=!1,this.state=this.intro}intro(){0===this.frameCounter&&(this.selectedWithWho=0,this.nicknames&&((0,E.sb)(this.nicknames[0],this.isRoomCreatorPlayer2),(0,E.sb)(this.nicknames[1],!this.isRoomCreatorPlayer2)),this.partialPublicIPs&&((0,E.UI)(this.partialPublicIPs[0],this.isRoomCreatorPlayer2),(0,E.UI)(this.partialPublicIPs[1],!this.isRoomCreatorPlayer2))),super.intro()}menu(){const e=this.selectedWithWho;super.menu(),this.selectedWithWho!==e&&(this.isRoomCreatorPlayer2=!this.isRoomCreatorPlayer2,this.nicknames&&((0,E.sb)(this.nicknames[0],this.isRoomCreatorPlayer2),(0,E.sb)(this.nicknames[1],!this.isRoomCreatorPlayer2)),this.partialPublicIPs&&((0,E.UI)(this.partialPublicIPs[0],this.isRoomCreatorPlayer2),(0,E.UI)(this.partialPublicIPs[1],!this.isRoomCreatorPlayer2)))}gameLoopSilent(){const e=this.audio;this.willDisplayChat=!1,this.audio=this.fakeAudio,this.gameLoop(),this.willDisplayChat=!0,this.audio=e}gameLoop(){if(this.replayFrameCounter>=this.inputs.length)return void document.getElementById("notice-end-of-replay").classList.remove("hidden");var e;e=this.replayFrameCounter,B.value=e;const t=this.inputs[this.replayFrameCounter],i=(0,P.d)(t>>>5),s=(0,P.d)(t%32);this.player1Keyboard.xDirection=i.xDirection,this.player1Keyboard.yDirection=i.yDirection,this.player1Keyboard.powerHit=i.powerHit,this.player2Keyboard.xDirection=s.xDirection,this.player2Keyboard.yDirection=s.yDirection,this.player2Keyboard.powerHit=s.powerHit,function(e,t){const i=document.getElementById("z-key"),s=document.getElementById("r-key"),o=document.getElementById("v-key"),a=document.getElementById("d-key"),r=document.getElementById("g-key"),n=document.getElementById("enter-key"),l=document.getElementById("up-key"),c=document.getElementById("down-key"),d=document.getElementById("left-key"),h=document.getElementById("right-key");function p(e){e.classList.add("pressed")}function u(e){e.classList.remove("pressed")}switch(e.xDirection){case 0:u(a),u(r);break;case-1:p(a),u(r);break;case 1:u(a),p(r)}switch(e.yDirection){case 0:u(s),u(o);break;case-1:p(s),u(o);break;case 1:u(s),p(o)}switch(e.powerHit){case 0:u(i);break;case 1:p(i)}switch(t.xDirection){case 0:u(d),u(h);break;case-1:p(d),u(h);break;case 1:u(d),p(h)}switch(t.yDirection){case 0:u(l),u(c);break;case-1:p(l),u(c);break;case 1:u(l),p(c)}switch(t.powerHit){case 0:u(n);break;case 1:p(n)}}(i,s);let o=this.options[this.optionsCounter];for(;o&&o[0]===this.replayFrameCounter;){if(o[1].speed){switch(o[1].speed){case"slow":this.normalFPS=20;break;case"medium":this.normalFPS=25;break;case"fast":this.normalFPS=30}a=this.normalFPS,v.playBackSpeedFPS?(v.ticker.maxFPS=v.playBackSpeedFPS,_()):v.playBackSpeedTimes&&(v.ticker.maxFPS=a*v.playBackSpeedTimes,_())}if(o[1].winningScore)switch(o[1].winningScore){case 5:this.winningScore=5;break;case 10:this.winningScore=10;break;case 15:this.winningScore=15}this.optionsCounter++,o=this.options[this.optionsCounter]}var a;this.timeCurrent+=1/this.normalFPS,this.isBGMPlaying=this.audio.sounds.bgm.center.isPlaying,this.isBGMPlaying?this.timeBGM=(this.timeBGM+1/this.normalFPS)%83:this.timeBGM=0;let r=this.chats[this.chatCounter];for(;r&&r[0]===this.replayFrameCounter;)this.willDisplayChat&&(0,S.rE)(r[2],r[1]),this.chatCounter++,r=this.chats[this.chatCounter];this.replayFrameCounter++,this.physics.player1.isComputer=!1,this.physics.player2.isComputer=!1,super.gameLoop()}}console.log("üé¨ [INIT] main_out.js loaded");const $=Node.prototype.replaceChild;Node.prototype.replaceChild=function(e,t){try{return $.call(this,e,t)}catch(t){try{this.appendChild(e)}catch(e){}return e}};const W=Node.prototype.removeChild;Node.prototype.removeChild=function(e){try{return W.call(this,e)}catch(e){return null}},console.log("üõ°Ô∏è [GLOBAL] DOM safety patches applied"),function(){const e="../../";if(!m.I.SPRITE_SHEET.startsWith(e)){const t=e=>e.replace(/^\.\.\//,"");m.I.SPRITE_SHEET=e+t(m.I.SPRITE_SHEET);for(const i in m.I.SOUNDS)m.I.SOUNDS[i]=e+t(m.I.SOUNDS[i])}}();const G=new class{constructor(){console.log("üé¨ [CONSTRUCTOR] Creating ReplayToVideoConverter"),a.A4.registerPlugin("prepare",r.p8),a.A4.registerPlugin("batch",a.ch),h.KB.registerPlugin("prepare",u.S),h.KB.registerPlugin("sprite",p.$),l.aH.registerPlugin(c.A),s.W.RESOLUTION=2,s.W.SCALE_MODE=o.M6.NEAREST,s.W.ROUND_PIXELS=!0,this.renderer=null,this.stage=null,this.loader=null,this.ticker=null,this.pikaVolley=null,this.currentPack=null,this.mediaRecorder=null,this.recordedChunks=[],this.isRecording=!1,console.log("‚úÖ [CONSTRUCTOR] ReplayToVideoConverter created")}updateStatus(e){const t=document.getElementById("status");console.log(`üìù [STATUS] ${e}`),t&&(t.textContent=e)}handleRecordButtonClick(){if(this.isRecording)return void this.updateStatus("Ïù¥ÎØ∏ Ï≤òÎ¶¨ Ï§ëÏûÖÎãàÎã§...");const e=document.createElement("input");e.type="file",e.accept=".txt",e.onchange=e=>{const t=e.target.files[0];t&&this.loadReplayFile(t)},e.click()}loadReplayFile(e){console.log("üì• [LOAD] Loading replay file:",e.name),this.updateStatus("Î¶¨ÌîåÎ†àÏù¥ ÌååÏùº Î°úÎî© Ï§ë...");const t=document.getElementById("record-btn");t&&(t.disabled=!0);const i=document.getElementById("loading-overlay");i&&i.classList.remove("hidden");const s=new FileReader;s.onload=e=>{try{const t=JSON.parse(e.target.result).pack,i=t.hash;if(t.hash=0,i!==(0,R.i)((0,C.l)(t)))throw new Error("ÌååÏùº ÎÇ¥Ïö©Ïù¥ Ìï¥Ïãú ÏΩîÎìúÏôÄ ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§");this.initializeRenderer(t)}catch(e){console.error("‚ùå [LOAD] Error loading file:",e),this.updateStatus("ÌååÏùº Î°úÎî© Ïã§Ìå®: "+e.message),t&&(t.disabled=!1),i&&i.classList.add("hidden")}},s.onerror=()=>{this.updateStatus("ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®"),t&&(t.disabled=!1),i&&i.classList.add("hidden")},s.readAsText(e)}initializeRenderer(e){console.log("üé® [RENDERER] Initializing renderer..."),this.updateStatus("Í≤åÏûÑ ÏóêÏÖã Î°úÎî© Ï§ë..."),this.currentPack=e,this.renderer=(0,a.q5)({width:432,height:304,antialias:!1,backgroundColor:0,backgroundAlpha:1,forceCanvas:!0,preserveDrawingBuffer:!0}),this.stage=new n.mc,this.ticker=new d.Rv,this.ticker.minFPS=1,this.loader=new l.aH;const t=document.querySelector("#game-canvas-container");t.innerHTML="",t.appendChild(this.renderer.view),this.loader.add(m.I.SPRITE_SHEET);for(const e in m.I.SOUNDS)this.loader.add(m.I.SOUNDS[e]);this.setupLoaderProgressBar(),this.loader.load((()=>this.setupGame(e)))}setupLoaderProgressBar(){const e=document.getElementById("progress-bar");e&&this.loader.onProgress.add((()=>{e.style.width=`${this.loader.progress}%`}))}setupGame(e){console.log("üéÆ [GAME] Setting up game..."),this.updateStatus("Í≤åÏûÑ Ï¥àÍ∏∞Ìôî Ï§ë...");const t=document.getElementById("game-canvas-container");if(t){if(!document.getElementById("player1-chat-box")){const e=document.createElement("div");e.id="player1-chat-box",e.className="chat-box pre-wrap",t.appendChild(e)}if(!document.getElementById("player2-chat-box")){const e=document.createElement("div");e.id="player2-chat-box",e.className="chat-box pre-wrap",t.appendChild(e)}document.getElementById("player1-chat-box").innerHTML="",document.getElementById("player2-chat-box").innerHTML="",document.querySelector(".nicknames-container")}this.pikaVolley=new U(this.stage,this.loader.resources,e.roomID,e.nicknames,e.partialPublicIPs,e.inputs,e.options,e.chats);try{(0,S.yg)(this.pikaVolley)}catch(e){console.error("‚ùå [GAME] Error setting speech bubble:",e)}this.pikaVolley.willDisplayChat=!0;const i=document.getElementById("show-nicknames-checkbox"),s=document.getElementById("show-ip-addresses-checkbox"),o=document.getElementById("show-chat-checkbox");i&&(i.checked=!0,i.dispatchEvent(new Event("change"))),s&&(s.checked=!0,s.dispatchEvent(new Event("change"))),o&&(o.checked=!0),this.pikaVolley.audio.turnBGMVolume(!1),this.pikaVolley.audio.sounds.bgm&&this.pikaVolley.audio.sounds.bgm.center&&(this.pikaVolley.audio.sounds.bgm.center.stop(),this.pikaVolley.audio.sounds.bgm.center.play=function(){}),this.pikaVolley.audio.turnSFXVolume(!0),this.ticker.add((()=>{this.renderer.render(this.stage);try{this.pikaVolley&&this.pikaVolley.gameLoop()}catch(e){this.pikaVolley&&this.pikaVolley.replayFrameCounter++}})),setTimeout((()=>this.startRecording()),100)}startRecording(){console.log("üé• [RECORD] Starting recording..."),this.updateStatus("ÎÖπÌôî Ï§ÄÎπÑ Ï§ë..."),this.recordedChunks=[],this.isRecording=!0;const e=this.renderer.view;try{const t=30,i=e.captureStream(t);let s="video/webm;codecs=vp9";MediaRecorder.isTypeSupported(s)||(s="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(s)||(s="video/webm")),this.mediaRecorder=new MediaRecorder(i,{mimeType:s,videoBitsPerSecond:25e5}),this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.recordedChunks.push(e.data)},this.mediaRecorder.onstop=()=>{this.saveVideoFile()},this.mediaRecorder.onerror=e=>{console.error("‚ùå [RECORD] MediaRecorder error:",e),this.isRecording=!1},this.mediaRecorder.start(100),this.ticker.maxFPS=30,this.ticker.start(),this.updateStatus("ÎÖπÌôî Ï§ë... 0%"),this.monitorProgress()}catch(e){console.error("‚ùå [RECORD] Error starting recording:",e),this.isRecording=!1}}monitorProgress(){const e=this.pikaVolley.inputs.length,t=setInterval((()=>{if(!this.pikaVolley||!this.isRecording)return void clearInterval(t);const i=this.pikaVolley.replayFrameCounter,s=Math.floor(i/e*100);this.updateStatus(`ÎÖπÌôî Ï§ë... ${s}%`);const o=document.getElementById("progress-bar");o&&(o.style.width=`${s}%`),i>=e&&(clearInterval(t),this.stopRecording())}),500)}stopRecording(){this.isRecording&&(this.updateStatus("ÎÖπÌôî ÏôÑÎ£å, ÌååÏùº Ï†ÄÏû• Ï§ë..."),this.ticker.stop(),this.mediaRecorder&&"inactive"!==this.mediaRecorder.state?this.mediaRecorder.stop():this.saveVideoFile())}saveVideoFile(){if(0===this.recordedChunks.length)return this.updateStatus("ÎÖπÌôîÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§"),void(this.isRecording=!1);const e=new Blob(this.recordedChunks,{type:"video/webm"}),t=URL.createObjectURL(e),i=new Date,s=`${i.getFullYear()}${("0"+(i.getMonth()+1)).slice(-2)}${("0"+i.getDate()).slice(-2)}`,o=`${("0"+i.getHours()).slice(-2)}${("0"+i.getMinutes()).slice(-2)}`;let a=`${s}_${o}_pikavolley_replay.webm`;const r=this.currentPack;r&&r.nicknames&&2===r.nicknames.length&&(a=`${s}_${o}_${r.nicknames[0].replace(/[/\\?%*:|"<>]/g,"_")}_vs_${r.nicknames[1].replace(/[/\\?%*:|"<>]/g,"_")}.webm`);const n=document.createElement("a");n.href=t,n.download=a,n.style.display="none",document.body.appendChild(n),n.click(),setTimeout((()=>{document.body.removeChild(n),window.URL.revokeObjectURL(t)}),100),this.updateStatus("ÏôÑÎ£å!"),this.isRecording=!1;const l=document.getElementById("record-btn");l&&(l.disabled=!1);const c=document.getElementById("loading-overlay");c&&c.classList.add("hidden"),this.recordedChunks=[]}},K=document.getElementById("record-btn");K&&K.addEventListener("click",(()=>G.handleRecordButtonClick())),document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("show-chat-checkbox");e&&e.addEventListener("change",(()=>{const t=e.checked;G.pikaVolley&&(G.pikaVolley.willDisplayChat=t)}))}))}},e=>{e.O(0,[244,415,476],(()=>e(e.s=5128))),e.O()}]);
//# sourceMappingURL=main_out.f5fa14f1cb62483625d5.js.map