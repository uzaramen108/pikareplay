"use strict";(self.webpackChunkpikachu_volleyball_p2p_online=self.webpackChunkpikachu_volleyball_p2p_online||[]).push([[293],{2601:(e,t,i)=>{var a=i(4603),n=i(6787),s=i(592),o=i(3650),l=i(9449),r=i(7561),c=i(7049),h=i(8077),d=i(4697),u=i(8505),p=(i(7229),i(6090)),m=i(3374),f=i(5523),g=i(6212),y=i(6970),k=i(7391),b=i.n(k),S=i(5046);console.log("ðŸŽ¬ [INIT] Offline Renderer (CSS Animation Sync)");const w=Node.prototype.replaceChild;Node.prototype.replaceChild=function(e,t){try{return w.call(this,e,t)}catch(t){try{this.appendChild(e)}catch(e){}return e}};const x=Node.prototype.removeChild;Node.prototype.removeChild=function(e){try{return x.call(this,e)}catch(e){return null}},function(){const e="../../";if(!p.I.SPRITE_SHEET.startsWith(e)){const t=e=>e.replace(/^\.\.\//,"");p.I.SPRITE_SHEET=e+t(p.I.SPRITE_SHEET);for(const i in p.I.SOUNDS)p.I.SOUNDS[i]=e+t(p.I.SOUNDS[i])}}();const E=new class{constructor(){s.A4.registerPlugin("prepare",o.p8),s.A4.registerPlugin("batch",s.ch),h.KB.registerPlugin("prepare",u.S),h.KB.registerPlugin("sprite",d.$),r.aH.registerPlugin(c.A),a.W.RESOLUTION=1,a.W.SCALE_MODE=n.M6.NEAREST,a.W.ROUND_PIXELS=!0,this.renderer=null,this.stage=null,this.loader=null,this.pikaVolley=null,this.audioLog=[],this.decodedBuffers={},this.totalDuration=0,this.chats=[],this.chatHead=0,this.activeBubbles=[],this.rng=null,this.muxer=null,this.videoEncoder=null,this.audioEncoder=null,this.chatSizeSelect=null,this.showNicknamesCheckbox=null,this.showIPsCheckbox=null,this.bgmCheckbox=null,this.sfxCheckbox=null,this.sharpGraphicsCheckbox=null}updateUI(){this.chatSizeSelect=document.getElementById("chat-size-select"),this.showNicknamesCheckbox=document.getElementById("show-nicknames-checkbox"),this.showIPsCheckbox=document.getElementById("show-ip-addresses-checkbox"),this.bgmCheckbox=document.getElementById("turn-on-bgm-checkbox"),this.sfxCheckbox=document.getElementById("turn-on-sfx-checkbox"),this.sharpGraphicsCheckbox=document.getElementById("graphic-sharp-checkbox")}updateStatus(e){const t=document.getElementById("status");t&&(t.textContent=e),console.log(`ðŸ“ [STATUS] ${e}`)}handleRecordButtonClick(){const e=document.createElement("input");e.type="file",e.accept=".txt",e.onchange=e=>{const t=e.target.files[0];t&&this.loadReplayFile(t)},e.click()}loadReplayFile(e){this.updateStatus("ë¦¬í”Œë ˆì´ ë¶„ì„ ì¤‘...");const t=new FileReader;t.onload=e=>{try{const t=JSON.parse(e.target.result).pack,i=t.hash;t.hash=0,i!==(0,y.i)((0,g.l)(t))&&console.warn("âš ï¸ Hash mismatch - ignored"),t.hash=i,this.initializeRenderer(t)}catch(e){console.error("âŒ Error:",e),this.updateStatus("íŒŒì¼ ë¡œë”© ì‹¤íŒ¨")}},t.readAsText(e)}initializeRenderer(e){this.updateStatus("ë¦¬ì†ŒìŠ¤ ë° ì˜¤ë””ì˜¤ ë””ì½”ë”© ì¤‘..."),this.renderer=(0,s.q5)({width:432,height:304,antialias:!1,backgroundColor:0,forceCanvas:!0,preserveDrawingBuffer:!0}),this.stage=new l.mc,this.loader=new r.aH;const t=document.querySelector("#game-canvas-container");t.innerHTML="",t.appendChild(this.renderer.view),this.ensureDOMElements(t),this.loader.add(p.I.SPRITE_SHEET);const i=[],a=new(window.AudioContext||window.webkitAudioContext),n={BGM:"bgm",PIPIKACHU:"pipikachu",PIKA:"pika",CHU:"chu",PI:"pi",PIKACHU:"pikachu",POWERHIT:"powerHit",BALLTOUCHESGROUND:"ballTouchesGround"};this.updateUI();for(const e in p.I.SOUNDS){const t=p.I.SOUNDS[e],s=fetch(t).then((e=>e.arrayBuffer())).then((e=>a.decodeAudioData(e))).then((t=>{const i=n[e]||e.toLowerCase();this.decodedBuffers[i]=t}));i.push(s),this.loader.add(p.I.SOUNDS[e])}Promise.all(i).then((()=>{this.loader.load((()=>this.startOfflineProcessing(e)))}))}ensureDOMElements(e){["player1-nickname","player2-nickname","player1-partial-ip","player2-partial-ip"].forEach((t=>{let i=document.getElementById(t);i?i.textContent="":(i=document.createElement("div"),i.id=t,i.style.display="none",e.appendChild(i))}))}async startOfflineProcessing(e){this.updateStatus("ì˜¤í”„ë¼ì¸ ë Œë”ë§ ì‹œìž‘..."),this.pikaVolley=new m.Z(this.stage,this.loader.resources,e.roomID,e.nicknames,e.partialPublicIPs,e.inputs,e.options,e.chats),null==this.pikaVolley.options.rule&&(this.pikaVolley.options.rule="default"),console.log(this.pikaVolley.options.rule),this.rng=b().alea(e.roomID.slice(10)),this.chats=e.chats||[],this.chatHead=0,this.activeBubbles=[];try{(0,f.yg)(this.pikaVolley)}catch(e){}this.pikaVolley.willDisplayChat=!0,this.audioLog=[],this.mockAudioSystem();const t=e.inputs.length;this.totalDuration=t/30,this.muxer=new S._j({target:new S.T9,video:{codec:"avc",width:432,height:304},audio:{codec:"aac",sampleRate:44100,numberOfChannels:2},fastStart:"in-memory"}),this.videoEncoder=new VideoEncoder({output:(e,t)=>this.muxer.addVideoChunk(e,t),error:e=>console.error("Video Error:",e)}),this.videoEncoder.configure({codec:"avc1.42001f",width:432,height:304,bitrate:5e5,framerate:30}),this.audioEncoder=new AudioEncoder({output:(e,t)=>this.muxer.addAudioChunk(e,t),error:e=>console.error("Audio Error:",e)}),this.audioEncoder.configure({codec:"mp4a.40.2",sampleRate:44100,numberOfChannels:2,bitrate:96e3});const i=document.getElementById("progress-bar");for(let e=0;e<t;e++){this.videoEncoder.encodeQueueSize>20&&await new Promise((e=>setTimeout(e,10)));try{this.pikaVolley.gameLoopSilent()}catch(e){}this.processChatFrame(e),this.renderer.render(this.stage),this.drawOverlaysOnCanvas();const a=await createImageBitmap(this.renderer.view),n=new VideoFrame(a,{timestamp:1e6*e/30}),s=e%90==0;if(this.videoEncoder.encode(n,{keyFrame:s}),n.close(),e%30==0){const a=Math.floor(e/t*100);this.updateStatus(`ì˜ìƒ ì²˜ë¦¬ ì¤‘... ${a}%`),i&&(i.style.width=`${a}%`),await new Promise((e=>setTimeout(e,0)))}}await this.videoEncoder.flush(),this.updateStatus("ì˜¤ë””ì˜¤ í•©ì„± ì¤‘..."),await this.synthesizeAndEncodeAudio(30),this.muxer.finalize();const a=this.muxer.target.buffer;this.saveFile(a)}processChatFrame(e){for(;this.chatHead<this.chats.length&&this.chats[this.chatHead][0]===e;){const e=this.chats[this.chatHead],t=e[1],i=e[2],a=this.rng(),n=this.rng(),s=432,o=304*(.2+.3*a);let l;l=1===t?s*(1-(.55+.25*n)):s*(.55+.25*n),this.activeBubbles=this.activeBubbles.filter((e=>e.side!==t)),this.activeBubbles.push({side:t,text:i,x:l,y:o,elapsed:0,duration:150}),this.chatHead++}for(let e=this.activeBubbles.length-1;e>=0;e--){const t=this.activeBubbles[e];t.elapsed++;const i=t.elapsed/t.duration;t.alpha=i<.25?i/.25:i<.75?1:1-(i-.75)/.25,t.elapsed>=t.duration&&this.activeBubbles.splice(e,1)}}mockAudioSystem(){this.pikaVolley.audio.turnBGMVolume(!1),this.pikaVolley.audio.turnSFXVolume(this.sfxCheckbox.checked);const e=this.pikaVolley.fakeAudio.sounds;for(const t in e)"bgm"!==t&&(e[t]={play:(e=0)=>{const i=this.pikaVolley.replayFrameCounter;this.audioLog.push({key:t,frame:i,pan:e})},stop:()=>{}})}async synthesizeAndEncodeAudio(e){if(0===this.audioLog.length)return;const t=44100,i=Math.ceil(this.totalDuration*t)+t,a=new OfflineAudioContext(2,i,t);this.audioLog.forEach((t=>{const i=this.decodedBuffers[t.key];if(i){const n=a.createBufferSource();n.buffer=i;const s=a.createStereoPanner();s.pan.value=.75*(t.pan||0),n.connect(s),s.connect(a.destination),n.start(t.frame/e)}}));const n=await a.startRendering();this.downloadWav(n);const s=n.length,o=n.numberOfChannels;for(let e=0;e<s;e+=4096){const i=Math.min(4096,s-e),a=new Float32Array(i*o);for(let t=0;t<o;t++){const s=n.getChannelData(t);a.set(s.subarray(e,e+i),t*i)}const l=new AudioData({format:"f32-planar",sampleRate:t,numberOfChannels:o,numberOfFrames:i,timestamp:e/t*1e6,data:a});this.audioEncoder.encode(l),l.close()}await this.audioEncoder.flush()}saveFile(e){const t=new Blob([e],{type:"video/mp4"}),i=URL.createObjectURL(t),a=new Date,n=`${a.getFullYear()}${String(a.getMonth()+1).padStart(2,"0")}${String(a.getDate()).padStart(2,"0")}`,s=`${String(a.getHours()).padStart(2,"0")}${String(a.getMinutes()).padStart(2,"0")}`;let o=`${n}_${s}_pikavolley_replay.mp4`;this.pikaVolley.nicknames&&2===this.pikaVolley.nicknames.length&&(o=`${n}_${s}_${this.pikaVolley.nicknames[0].replace(/[/\\?%*:|"<>]/g,"_")}_vs_${this.pikaVolley.nicknames[1].replace(/[/\\?%*:|"<>]/g,"_")}.mp4`);const l=document.createElement("a");l.href=i,l.download=o,l.click(),this.updateStatus("ì™„ë£Œ!");const r=document.getElementById("record-btn");r&&(r.disabled=!1);const c=document.getElementById("loading-overlay");c&&c.classList.add("hidden"),setTimeout((()=>{URL.revokeObjectURL(i),this.muxer=null,this.videoEncoder=null,this.audioEncoder=null,this.audioLog=[]}),1e3)}drawOverlaysOnCanvas(){const e=this.renderer.view.getContext("2d");if(!e)return;e.save();let t="",i="",a="",n="";this.showNicknamesCheckbox.checked&&(t=document.getElementById("player1-nickname")?.textContent||"",i=document.getElementById("player2-nickname")?.textContent||""),this.showIPsCheckbox.checked&&(a=document.getElementById("player1-partial-ip")?.textContent||"",n=document.getElementById("player2-partial-ip")?.textContent||"");const s=t,o=i,l=a,r=n;s&&(e.font='bold 12px "Segoe UI", sans-serif',e.textAlign="center",e.textBaseline="top",e.fillStyle="white",e.strokeStyle="black",e.lineWidth=1,e.strokeText(s,166,10),e.fillText(s,166,10),l&&(e.font="8px sans-serif",e.lineWidth=1,e.strokeText(l,166,25),e.fillText(l,166,25))),o&&(e.font='bold 12px "Segoe UI", sans-serif',e.textAlign="center",e.textBaseline="top",e.fillStyle="white",e.strokeStyle="black",e.lineWidth=1,e.strokeText(o,266,10),e.fillText(o,266,10),r&&(e.font="8px sans-serif",e.lineWidth=1,e.strokeText(r,266,25),e.fillText(r,266,25))),this.activeBubbles.forEach((t=>{this.drawSpeechBubble(e,t.text,t.x,t.y,t.alpha)})),e.restore()}drawSpeechBubble(e,t,i,a,n){if(!t)return;if(e.save(),e.globalAlpha=n,"large"===this.chatSizeSelect.value)e.font='18px "Segoe UI", sans-serif';else{if("small"!==this.chatSizeSelect.value)return;e.font='12px "Segoe UI", sans-serif'}e.font="12px sans-serif",e.textAlign="center",e.textBaseline="middle";const s=e.measureText(t).width+12,o=30,l=10,r=i-s/2,c=a;e.beginPath(),e.moveTo(r+l,c),e.lineTo(r+s-l,c),e.quadraticCurveTo(r+s,c,r+s,c+l),e.lineTo(r+s,c+o-l),e.quadraticCurveTo(r+s,c+o,r+s-l,c+o),e.lineTo(r+l,c+o),e.quadraticCurveTo(r,c+o,r,c+o-l),e.lineTo(r,c+l),e.quadraticCurveTo(r,c,r+l,c),e.closePath(),e.fillStyle="rgba(255, 255, 255, 0.95)",e.fill(),e.fillStyle="black",e.fillText(t,i,c+15),e.restore()}downloadWav(e){const t=this.bufferToWave(e,e.length),i=new Blob([t],{type:"audio/wav"}),a=URL.createObjectURL(i),n=document.createElement("a");n.href=a,n.download="pikavolley_audio.wav",n.style.display="none",document.body.appendChild(n),n.click(),setTimeout((()=>{document.body.removeChild(n),URL.revokeObjectURL(a)}),1e3)}bufferToWave(e,t){const i=e.numberOfChannels,a=t*i*2+44,n=new ArrayBuffer(a),s=new DataView(n),o=[];let l,r,c=0,h=0;for(u(1179011410),u(a-8),u(1163280727),u(544501094),u(16),d(1),d(i),u(e.sampleRate),u(2*e.sampleRate*i),d(2*i),d(16),u(1635017060),u(a-h-4),l=0;l<e.numberOfChannels;l++)o.push(e.getChannelData(l));for(;h<t;){for(l=0;l<i;l++)r=Math.max(-1,Math.min(1,o[l][h])),r=0|(.5+r<0?32768*r:32767*r),s.setInt16(44+c,r,!0),c+=2;h++}function d(e){s.setUint16(h,e,!0),h+=2}function u(e){s.setUint32(h,e,!0),h+=4}return n}},C=document.getElementById("record-btn");C&&C.addEventListener("click",(()=>E.handleRecordButtonClick()))}},e=>{e.O(0,[244,46,415,958],(()=>e(e.s=2601))),e.O()}]);
//# sourceMappingURL=main_out.2184d49e215e723953df.js.map