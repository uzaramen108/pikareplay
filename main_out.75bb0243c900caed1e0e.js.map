{"version":3,"file":"main_out.75bb0243c900caed1e0e.js","mappings":"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","sources":["webpack://pikachu-volleyball-p2p-online/./src/resources/js/replay/replay_saver_download.js","webpack://pikachu-volleyball-p2p-online/./src/resources/js/replay/main_out.js"],"sourcesContent":["'use strict';\r\nimport { settings } from '@pixi/settings';\r\nimport { SCALE_MODES } from '@pixi/constants';\r\nimport { Renderer, BatchRenderer, autoDetectRenderer } from '@pixi/core';\r\nimport { Prepare } from '@pixi/prepare';\r\nimport { Container } from '@pixi/display';\r\nimport { Loader } from '@pixi/loaders';\r\nimport { SpritesheetLoader } from '@pixi/spritesheet';\r\nimport { Ticker } from '@pixi/ticker';\r\nimport { CanvasRenderer } from '@pixi/canvas-renderer';\r\nimport { CanvasSpriteRenderer } from '@pixi/canvas-sprite';\r\nimport { CanvasPrepare } from '@pixi/canvas-prepare';\r\nimport '@pixi/canvas-display';\r\nimport { ASSETS_PATH } from '../offline_version_js/assets_path.js';\r\nimport { PikachuVolleyballReplay } from './pikavolley_replay.js';\r\nimport { serialize } from '../utils/serialize.js';\r\nimport { getHashCode } from '../utils/hash_code.js';\r\n\r\nsettings.RESOLUTION = 2;\r\nsettings.SCALE_MODE = SCALE_MODES.NEAREST;\r\nsettings.ROUND_PIXELS = true;\r\n\r\nRenderer.registerPlugin('prepare', Prepare);\r\nRenderer.registerPlugin('batch', BatchRenderer);\r\nCanvasRenderer.registerPlugin('prepare', CanvasPrepare);\r\nCanvasRenderer.registerPlugin('sprite', CanvasSpriteRenderer);\r\nLoader.registerPlugin(SpritesheetLoader);\r\n\r\nclass ReplaySaver {\r\n  constructor() {\r\n    this.renderer = autoDetectRenderer({\r\n      width: 432,\r\n      height: 304,\r\n      antialias: false,\r\n      backgroundColor: 0x000000,\r\n      backgroundAlpha: 1,\r\n      forceCanvas: true, \r\n      preserveDrawingBuffer: true,\r\n    });\r\n\r\n    this.stage = new Container();\r\n    this.loader = new Loader();\r\n    this.pikaVolley = null;\r\n    this.ticker = new Ticker();\r\n    this.mediaRecorder = null;\r\n    this.recordedChunks = [];\r\n  }\r\n\r\n  initAndStart(file, onStatusChange, onFinish) {\r\n    this.onStatusChange = onStatusChange;\r\n    this.onFinish = onFinish;\r\n\r\n    const container = document.getElementById('game-canvas-container');\r\n    container.innerHTML = '';\r\n    container.appendChild(this.renderer.view);\r\n\r\n    this.loader.reset(); \r\n    this.loader.add(ASSETS_PATH.SPRITE_SHEET);\r\n    // 소리는 로드만 하고 재생은 안 함\r\n    for (const prop in ASSETS_PATH.SOUNDS) {\r\n      this.loader.add(ASSETS_PATH.SOUNDS[prop]);\r\n    }\r\n\r\n    const reader = new FileReader();\r\n    reader.onload = (event) => {\r\n      this._parseAndLoadGame(event.target.result);\r\n    };\r\n    reader.readAsText(file);\r\n  }\r\n\r\n  _parseAndLoadGame(jsonString) {\r\n    let pack;\r\n    try {\r\n      const packWithComment = JSON.parse(jsonString);\r\n      pack = packWithComment.pack;\r\n      \r\n      const hash = pack.hash;\r\n      pack.hash = 0;\r\n      if (hash !== getHashCode(serialize(pack))) {\r\n        throw 'Error: File hash mismatch';\r\n      }\r\n    } catch (err) {\r\n      console.error(err);\r\n      if (this.onStatusChange) this.onStatusChange(\"오류: 손상된 리플레이 파일입니다.\");\r\n      return;\r\n    }\r\n\r\n    if (this.onStatusChange) this.onStatusChange(\"리소스 로딩 중...\");\r\n    this.loader.load(() => {\r\n      this._createGame(pack);\r\n    });\r\n  }\r\n\r\n  _createGame(pack) {\r\n    const TEXTURES = ASSETS_PATH.TEXTURES;\r\n    TEXTURES.WITH_COMPUTER = TEXTURES.WITH_FRIEND;\r\n\r\n    this.pikaVolley = new PikachuVolleyballReplay(\r\n      this.stage,\r\n      this.loader.resources,\r\n      pack.roomID,\r\n      pack.nicknames,\r\n      pack.partialPublicIPs,\r\n      pack.inputs,\r\n      pack.options,\r\n      pack.chats\r\n    );\r\n\r\n    // [중요] 오디오 에러 방지를 위해 강제로 가짜 오디오 사용\r\n    // PikachuVolleyballReplay 생성자에서 fakeAudio를 만들어두므로 그걸 그대로 덮어씀\r\n    // @ts-ignore\r\n    this.pikaVolley.audio = this.pikaVolley.fakeAudio;\r\n\r\n    if (this.onStatusChange) this.onStatusChange(\"녹화 시작! (화면을 유지해주세요)\");\r\n    this._startRecordingLoop();\r\n  }\r\n\r\n  _startRecordingLoop() {\r\n    const canvas = this.renderer.view;\r\n    // 60FPS로 캡처\r\n    const stream = canvas.captureStream(60);\r\n    \r\n    // 코덱 지원 여부 확인\r\n    let mimeType = 'video/webm';\r\n    if (MediaRecorder.isTypeSupported('video/webm; codecs=vp9')) {\r\n      mimeType = 'video/webm; codecs=vp9';\r\n    } else if (MediaRecorder.isTypeSupported('video/webm; codecs=vp8')) {\r\n      mimeType = 'video/webm; codecs=vp8';\r\n    }\r\n\r\n    this.mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });\r\n    this.recordedChunks = [];\r\n\r\n    this.mediaRecorder.ondataavailable = (e) => {\r\n      if (e.data.size > 0) this.recordedChunks.push(e.data);\r\n    };\r\n\r\n    this.mediaRecorder.onstop = () => {\r\n      this._finalizeDownload();\r\n    };\r\n\r\n    this.mediaRecorder.start();\r\n\r\n    // Ticker(게임 루프) 재설정\r\n    this.ticker.stop();\r\n    this.ticker = new Ticker();\r\n    this.ticker.minFPS = 60;\r\n    this.ticker.maxFPS = 60; // 정속 녹화\r\n\r\n    this.ticker.add(() => {\r\n      this.renderer.render(this.stage);\r\n      if (this.pikaVolley) {\r\n        // UI 갱신 함수들이 실행되겠지만, index.html의 가짜 요소들 덕분에 에러 안 남\r\n        this.pikaVolley.gameLoop();\r\n\r\n        if (this.pikaVolley.replayFrameCounter >= this.pikaVolley.inputs.length) {\r\n            this.ticker.stop();\r\n            this.mediaRecorder.stop();\r\n            if (this.onStatusChange) this.onStatusChange(\"변환 완료! 파일 생성 중...\");\r\n        }\r\n      }\r\n    });\r\n\r\n    this.ticker.start();\r\n  }\r\n\r\n  _finalizeDownload() {\r\n    const blob = new Blob(this.recordedChunks, { type: 'video/webm' });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.style.display = 'none';\r\n    a.href = url;\r\n    a.download = `pikachu_replay_${Date.now()}.webm`;\r\n    document.body.appendChild(a);\r\n    a.click();\r\n    \r\n    setTimeout(() => {\r\n      document.body.removeChild(a);\r\n      window.URL.revokeObjectURL(url);\r\n      if (this.onFinish) this.onFinish();\r\n    }, 100);\r\n  }\r\n}\r\n\r\nexport const replaySaver = new ReplaySaver();","import { replaySaver } from './replay_saver_download.js';\r\n\r\nconst uploadBtn = document.getElementById('record-btn');\r\nconst statusDiv = document.getElementById('status');\r\n\r\nif (uploadBtn) {\r\n  uploadBtn.addEventListener('click', () => {\r\n    // 동적 파일 선택창 생성\r\n    const input = document.createElement('input');\r\n    input.type = 'file';\r\n    input.accept = '.txt';\r\n\r\n    input.onchange = (event) => {\r\n      // @ts-ignore\r\n      const file = event.target.files[0];\r\n      if (!file) return;\r\n\r\n      statusDiv.innerText = \"리플레이 파일을 분석 중입니다...\";\r\n\r\n      replaySaver.initAndStart(\r\n        file,\r\n        (msg) => {\r\n          statusDiv.innerText = msg;\r\n        },\r\n        () => {\r\n          statusDiv.innerText = \"다운로드가 완료되었습니다!\";\r\n        }\r\n      );\r\n    };\r\n\r\n    input.click();\r\n  });\r\n}"],"names":["settings","RESOLUTION","SCALE_MODE","NEAREST","ROUND_PIXELS","registerPlugin","replaySaver","constructor","this","renderer","width","height","antialias","backgroundColor","backgroundAlpha","forceCanvas","preserveDrawingBuffer","stage","loader","pikaVolley","ticker","mediaRecorder","recordedChunks","initAndStart","file","onStatusChange","onFinish","container","document","getElementById","innerHTML","appendChild","view","reset","add","SPRITE_SHEET","prop","SOUNDS","reader","FileReader","onload","event","_parseAndLoadGame","target","result","readAsText","jsonString","pack","packWithComment","JSON","parse","hash","serialize","err","console","error","load","_createGame","TEXTURES","WITH_COMPUTER","WITH_FRIEND","resources","roomID","nicknames","partialPublicIPs","inputs","options","chats","audio","fakeAudio","_startRecordingLoop","stream","captureStream","mimeType","MediaRecorder","isTypeSupported","ondataavailable","e","data","size","push","onstop","_finalizeDownload","start","stop","minFPS","maxFPS","render","gameLoop","replayFrameCounter","length","blob","Blob","type","url","URL","createObjectURL","a","createElement","style","display","href","download","Date","now","body","click","setTimeout","removeChild","window","revokeObjectURL","uploadBtn","statusDiv","addEventListener","input","accept","onchange","files","innerText","msg"],"sourceRoot":""}